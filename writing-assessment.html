<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>IELTS Writing Assessment - AI Examiner</title>
    <link rel="icon" type="image/x-icon" href="icon/favicon.ico">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <script defer src="https://unpkg.com/alpinejs@3.x.x/dist/cdn.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            min-height: 100vh;
            background: linear-gradient(135deg, #0a0a0a 0%, #1a1a1a 50%, #0d0d0d 100%);
            font-family: 'Inter', sans-serif;
            color: #fff;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }

        /* Header */
        .header {
            text-align: center;
            padding: 30px 0;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            margin-bottom: 30px;
        }

        .header h1 {
            font-size: 2.5rem;
            font-weight: 700;
            background: linear-gradient(135deg, #3b82f6, #8b5cf6);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            margin-bottom: 10px;
        }

        .header p {
            color: rgba(255, 255, 255, 0.6);
            font-size: 1.1rem;
        }

        /* Main Layout */
        .main-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 30px;
        }

        @media (max-width: 1024px) {
            .main-grid {
                grid-template-columns: 1fr;
            }
        }

        /* Cards */
        .card {
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 16px;
            padding: 24px;
        }

        .card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .card-title {
            font-size: 1.25rem;
            font-weight: 600;
            color: #fff;
        }

        /* API Key Section */
        .api-key-section {
            margin-bottom: 20px;
            padding: 16px;
            background: rgba(59, 130, 246, 0.1);
            border: 1px solid rgba(59, 130, 246, 0.2);
            border-radius: 12px;
        }

        .api-key-input {
            width: 100%;
            padding: 12px 16px;
            background: rgba(0, 0, 0, 0.3);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 8px;
            color: #fff;
            font-size: 0.9rem;
            margin-top: 10px;
        }

        .api-key-input:focus {
            outline: none;
            border-color: #3b82f6;
        }

        /* Task Type Selector */
        .task-selector {
            display: flex;
            gap: 12px;
            margin-bottom: 20px;
        }

        .task-btn {
            flex: 1;
            padding: 14px;
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 12px;
            color: rgba(255, 255, 255, 0.7);
            font-size: 0.95rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s;
        }

        .task-btn:hover {
            background: rgba(255, 255, 255, 0.1);
        }

        .task-btn.active {
            background: linear-gradient(135deg, rgba(59, 130, 246, 0.2), rgba(139, 92, 246, 0.2));
            border-color: #3b82f6;
            color: #fff;
        }

        /* Essay Input */
        .essay-textarea {
            width: 100%;
            min-height: 350px;
            background: rgba(0, 0, 0, 0.3);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 12px;
            padding: 20px;
            color: #fff;
            font-size: 1rem;
            line-height: 1.8;
            resize: vertical;
            font-family: 'Inter', sans-serif;
        }

        .essay-textarea:focus {
            outline: none;
            border-color: #3b82f6;
        }

        .essay-textarea::placeholder {
            color: rgba(255, 255, 255, 0.3);
        }

        /* Word Counter */
        .word-counter {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-top: 15px;
            padding: 12px 16px;
            background: rgba(0, 0, 0, 0.2);
            border-radius: 8px;
        }

        .word-count {
            font-size: 1.1rem;
            font-weight: 600;
        }

        .word-count.warning {
            color: #f59e0b;
        }

        .word-count.success {
            color: #22c55e;
        }

        .word-count.error {
            color: #ef4444;
        }

        /* Submit Button */
        .submit-btn {
            width: 100%;
            padding: 18px 24px;
            margin-top: 20px;
            background: linear-gradient(135deg, #3b82f6, #8b5cf6);
            border: none;
            border-radius: 12px;
            color: #fff;
            font-size: 1.1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
        }

        .submit-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 30px rgba(59, 130, 246, 0.3);
        }

        .submit-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }

        /* Band Scores */
        .band-scores {
            display: grid;
            grid-template-columns: repeat(5, 1fr);
            gap: 12px;
            margin-bottom: 24px;
        }

        @media (max-width: 768px) {
            .band-scores {
                grid-template-columns: repeat(3, 1fr);
            }
        }

        .band-score-item {
            text-align: center;
            padding: 16px 8px;
            background: rgba(0, 0, 0, 0.2);
            border-radius: 12px;
            border: 1px solid rgba(255, 255, 255, 0.1);
            cursor: pointer;
            transition: all 0.2s;
        }

        .band-score-item:hover {
            background: rgba(255, 255, 255, 0.05);
        }

        .band-score-item.overall {
            background: linear-gradient(135deg, rgba(59, 130, 246, 0.2), rgba(139, 92, 246, 0.2));
            border-color: rgba(59, 130, 246, 0.3);
        }

        .band-score-value {
            font-size: 2rem;
            font-weight: 700;
            color: #3b82f6;
        }

        .band-score-label {
            font-size: 0.7rem;
            color: rgba(255, 255, 255, 0.6);
            margin-top: 4px;
        }

        /* Tabs */
        .tabs {
            display: flex;
            gap: 8px;
            margin-bottom: 20px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            padding-bottom: 12px;
            flex-wrap: wrap;
        }

        .tab-btn {
            padding: 10px 16px;
            background: transparent;
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 8px;
            color: rgba(255, 255, 255, 0.6);
            font-size: 0.85rem;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .tab-btn.active {
            background: rgba(59, 130, 246, 0.2);
            border-color: #3b82f6;
            color: #3b82f6;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        /* Improved Essay */
        .improved-essay {
            background: rgba(0, 0, 0, 0.3);
            border-radius: 12px;
            padding: 24px;
            line-height: 2;
            font-size: 1rem;
            white-space: pre-wrap;
            max-height: 500px;
            overflow-y: auto;
        }

        /* Error/Correction Items */
        .correction-item {
            padding: 16px;
            background: rgba(0, 0, 0, 0.2);
            border-radius: 12px;
            margin-bottom: 12px;
            border-left: 4px solid;
        }

        .correction-item.error {
            border-left-color: #ef4444;
        }

        .correction-item.vocabulary {
            border-left-color: #3b82f6;
        }

        .correction-item.grammar {
            border-left-color: #a855f7;
        }

        .correction-type {
            font-size: 0.75rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 8px;
        }

        .correction-type.error {
            color: #ef4444;
        }

        .correction-type.vocabulary {
            color: #3b82f6;
        }

        .correction-type.grammar {
            color: #a855f7;
        }

        .correction-original {
            color: #ef4444;
            text-decoration: line-through;
        }

        .correction-arrow {
            color: rgba(255, 255, 255, 0.4);
            margin: 0 10px;
        }

        .correction-new {
            color: #22c55e;
            font-weight: 500;
        }

        .correction-explanation {
            margin-top: 10px;
            font-size: 0.9rem;
            color: rgba(255, 255, 255, 0.7);
            font-style: italic;
            padding: 10px;
            background: rgba(255, 255, 255, 0.03);
            border-radius: 8px;
        }

        /* Key Points */
        .key-point {
            padding: 16px;
            background: rgba(0, 0, 0, 0.2);
            border-radius: 12px;
            margin-bottom: 12px;
            border-left: 4px solid #f59e0b;
        }

        .key-point-area {
            font-size: 0.7rem;
            font-weight: 600;
            text-transform: uppercase;
            color: #f59e0b;
            margin-bottom: 6px;
        }

        .key-point-title {
            font-weight: 600;
            margin-bottom: 8px;
        }

        .key-point-practice {
            font-size: 0.85rem;
            color: rgba(255, 255, 255, 0.6);
            margin-top: 8px;
            padding: 8px;
            background: rgba(245, 158, 11, 0.1);
            border-radius: 6px;
        }

        /* Paragraph Feedback */
        .paragraph-feedback {
            padding: 16px;
            background: rgba(0, 0, 0, 0.2);
            border-radius: 12px;
            margin-bottom: 12px;
        }

        .paragraph-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
        }

        .paragraph-type {
            font-size: 0.7rem;
            padding: 4px 10px;
            background: rgba(59, 130, 246, 0.2);
            color: #3b82f6;
            border-radius: 20px;
            text-transform: uppercase;
        }

        .topic-sentence-badge {
            font-size: 0.7rem;
            padding: 4px 10px;
            border-radius: 20px;
        }

        .topic-sentence-badge.good {
            background: rgba(34, 197, 94, 0.2);
            color: #22c55e;
        }

        .topic-sentence-badge.needs-improvement {
            background: rgba(245, 158, 11, 0.2);
            color: #f59e0b;
        }

        .topic-sentence-badge.missing {
            background: rgba(239, 68, 68, 0.2);
            color: #ef4444;
        }

        .cohesive-devices {
            display: flex;
            flex-wrap: wrap;
            gap: 6px;
            margin-top: 10px;
        }

        .device-tag {
            font-size: 0.75rem;
            padding: 4px 8px;
            background: rgba(168, 85, 247, 0.2);
            color: #a855f7;
            border-radius: 6px;
        }

        .device-tag.suggested {
            background: rgba(34, 197, 94, 0.2);
            color: #22c55e;
            border: 1px dashed #22c55e;
        }

        /* Strengths/Weaknesses */
        .feedback-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 16px;
            margin-top: 20px;
        }

        @media (max-width: 768px) {
            .feedback-grid {
                grid-template-columns: 1fr;
            }
        }

        .feedback-box {
            padding: 16px;
            border-radius: 12px;
        }

        .feedback-box.strengths {
            background: rgba(34, 197, 94, 0.1);
            border: 1px solid rgba(34, 197, 94, 0.2);
        }

        .feedback-box.weaknesses {
            background: rgba(239, 68, 68, 0.1);
            border: 1px solid rgba(239, 68, 68, 0.2);
        }

        .feedback-box-title {
            font-weight: 600;
            margin-bottom: 12px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .feedback-box.strengths .feedback-box-title {
            color: #22c55e;
        }

        .feedback-box.weaknesses .feedback-box-title {
            color: #ef4444;
        }

        .feedback-list {
            list-style: none;
        }

        .feedback-list li {
            padding: 8px 0;
            font-size: 0.9rem;
            color: rgba(255, 255, 255, 0.8);
            border-bottom: 1px solid rgba(255, 255, 255, 0.05);
        }

        .feedback-list li:last-child {
            border-bottom: none;
        }

        .feedback-list li::before {
            content: "•";
            margin-right: 8px;
            color: rgba(255, 255, 255, 0.4);
        }

        /* Band Score Feedback Modal */
        .score-feedback {
            margin-top: 12px;
            padding: 12px;
            background: rgba(0, 0, 0, 0.2);
            border-radius: 8px;
            font-size: 0.9rem;
            color: rgba(255, 255, 255, 0.8);
            line-height: 1.6;
        }

        /* Loading */
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.9);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 1000;
        }

        .loading-spinner {
            width: 60px;
            height: 60px;
            border: 4px solid rgba(255, 255, 255, 0.1);
            border-top-color: #3b82f6;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            to {
                transform: rotate(360deg);
            }
        }

        /* Summary Stats */
        .summary-stats {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 12px;
            margin-bottom: 24px;
        }

        .stat-item {
            text-align: center;
            padding: 16px;
            background: rgba(0, 0, 0, 0.2);
            border-radius: 12px;
        }

        .stat-value {
            font-size: 1.5rem;
            font-weight: 700;
        }

        .stat-value.errors {
            color: #ef4444;
        }

        .stat-value.vocab {
            color: #3b82f6;
        }

        .stat-value.grammar {
            color: #a855f7;
        }

        .stat-value.level {
            color: #22c55e;
        }

        .stat-label {
            font-size: 0.75rem;
            color: rgba(255, 255, 255, 0.6);
            margin-top: 4px;
        }

        /* Copy Button */
        .copy-btn {
            padding: 10px 20px;
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 8px;
            color: #fff;
            font-size: 0.9rem;
            cursor: pointer;
            transition: all 0.2s;
        }

        .copy-btn:hover {
            background: rgba(255, 255, 255, 0.15);
        }

        /* Back Link */
        .back-link {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            color: rgba(255, 255, 255, 0.6);
            text-decoration: none;
            font-size: 0.9rem;
            margin-bottom: 20px;
            transition: color 0.2s ease;
        }

        .back-link:hover {
            color: #fff;
        }

        /* No Results */
        .no-results {
            text-align: center;
            padding: 60px 20px;
            color: rgba(255, 255, 255, 0.5);
        }

        [x-cloak] {
            display: none !important;
        }
    </style>
</head>

<body>
    <div class="container" x-data="writingAssessment()" x-cloak>
        <a href="ielts.html" class="back-link">
            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M19 12H5M12 19l-7-7 7-7" />
            </svg>
            Back to IELTS
        </a>

        <div class="header">
            <h1>IELTS Writing Assessment</h1>
            <p>AI-Powered Examiner - Get detailed feedback based on official IELTS criteria</p>
        </div>

        <!-- Loading Overlay -->
        <div class="loading-overlay" x-show="isLoading" x-cloak>
            <div class="loading-spinner"></div>
            <p style="margin-top: 20px; color: rgba(255,255,255,0.7);">Analyzing your essay...</p>
            <p style="margin-top: 8px; font-size: 0.85rem; color: rgba(255,255,255,0.5);">This may take 15-30 seconds
            </p>
        </div>

        <div class="main-grid">
            <!-- Left Column - Input -->
            <div>
                <div class="card">
                    <div class="card-header">
                        <h2 class="card-title">Your Essay</h2>
                    </div>

                    <!-- API Key Section -->
                    <div class="api-key-section">
                        <label
                            style="font-size: 0.9rem; color: rgba(255,255,255,0.7); display: flex; align-items: center; gap: 8px;">
                            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                                stroke-width="2">
                                <rect x="3" y="11" width="18" height="11" rx="2" ry="2" />
                                <path d="M7 11V7a5 5 0 0 1 10 0v4" />
                            </svg>
                            OpenAI API Key
                        </label>
                        <input type="password" class="api-key-input" x-model="apiKey" placeholder="sk-..."
                            @change="saveApiKey()">
                        <p style="font-size: 0.75rem; color: rgba(255,255,255,0.5); margin-top: 8px;">
                            Your key is stored locally in your browser only. <a
                                href="https://platform.openai.com/api-keys" target="_blank" style="color: #3b82f6;">Get
                                API Key</a>
                        </p>
                    </div>

                    <!-- Task Type Selector -->
                    <div class="task-selector">
                        <button class="task-btn" :class="{ 'active': taskType === 'task2' }"
                            @click="taskType = 'task2'">
                            Task 2 (Essay)
                        </button>
                        <button class="task-btn" :class="{ 'active': taskType === 'task1' }"
                            @click="taskType = 'task1'">
                            Task 1 (Report)
                        </button>
                    </div>

                    <!-- Essay Question -->
                    <div style="margin-bottom: 16px;">
                        <label
                            style="font-size: 0.9rem; color: rgba(255,255,255,0.7); display: block; margin-bottom: 8px;">
                            Essay Question/Topic
                        </label>
                        <textarea x-model="essayQuestion"
                            style="width: 100%; min-height: 80px; background: rgba(0,0,0,0.3); border: 1px solid rgba(255,255,255,0.1); border-radius: 8px; padding: 12px; color: #fff; font-size: 0.9rem; resize: vertical;"
                            placeholder="Paste the essay question here (optional but recommended for better assessment)..."></textarea>
                    </div>

                    <!-- Essay Input -->
                    <textarea class="essay-textarea" x-model="essay"
                        :placeholder="taskType === 'task2' ? 'Paste or write your IELTS Task 2 essay here (minimum 250 words)...' : 'Paste or write your IELTS Task 1 report here (minimum 150 words)...'"></textarea>

                    <!-- Word Counter -->
                    <div class="word-counter">
                        <span class="word-count" :class="{
                            'error': wordCount < minWords * 0.8,
                            'warning': wordCount >= minWords * 0.8 && wordCount < minWords,
                            'success': wordCount >= minWords
                        }">
                            <span x-text="wordCount"></span> words
                        </span>
                        <span style="font-size: 0.85rem; color: rgba(255,255,255,0.5);">
                            Minimum: <span x-text="minWords"></span> words
                        </span>
                    </div>

                    <!-- Submit Button -->
                    <button class="submit-btn" @click="assessEssay()" :disabled="!canSubmit || isLoading">
                        <svg x-show="!isLoading" width="20" height="20" viewBox="0 0 24 24" fill="none"
                            stroke="currentColor" stroke-width="2">
                            <path d="M22 2L11 13M22 2l-7 20-4-9-9-4 20-7z" />
                        </svg>
                        <span x-show="!isLoading">Send to AI Examiner</span>
                        <span x-show="isLoading">Analyzing...</span>
                    </button>
                </div>
            </div>

            <!-- Right Column - Results -->
            <div>
                <div class="card" x-show="hasResults">
                    <div class="card-header">
                        <h2 class="card-title">Assessment Results</h2>
                        <span style="font-size: 0.8rem; color: rgba(255,255,255,0.5);">
                            Level: <span x-text="results.summary?.estimatedCurrentLevel || '-'"
                                style="color: #22c55e; font-weight: 600;"></span>
                        </span>
                    </div>

                    <!-- Band Scores -->
                    <div class="band-scores">
                        <div class="band-score-item" @click="selectedScore = selectedScore === 'ta' ? null : 'ta'">
                            <div class="band-score-value" x-text="results.bandScores?.taskAchievement || '-'"></div>
                            <div class="band-score-label">Task</div>
                        </div>
                        <div class="band-score-item" @click="selectedScore = selectedScore === 'cc' ? null : 'cc'">
                            <div class="band-score-value" x-text="results.bandScores?.coherenceCohesion || '-'"></div>
                            <div class="band-score-label">Coherence</div>
                        </div>
                        <div class="band-score-item" @click="selectedScore = selectedScore === 'lr' ? null : 'lr'">
                            <div class="band-score-value" x-text="results.bandScores?.lexicalResource || '-'"></div>
                            <div class="band-score-label">Vocabulary</div>
                        </div>
                        <div class="band-score-item" @click="selectedScore = selectedScore === 'gr' ? null : 'gr'">
                            <div class="band-score-value" x-text="results.bandScores?.grammaticalRange || '-'"></div>
                            <div class="band-score-label">Grammar</div>
                        </div>
                        <div class="band-score-item overall">
                            <div class="band-score-value" x-text="results.bandScores?.overall || '-'"></div>
                            <div class="band-score-label">Overall</div>
                        </div>
                    </div>

                    <!-- Score Feedback -->
                    <div class="score-feedback" x-show="selectedScore">
                        <template x-if="selectedScore === 'ta'">
                            <p x-text="results.bandScores?.taskAchievementFeedback"></p>
                        </template>
                        <template x-if="selectedScore === 'cc'">
                            <p x-text="results.bandScores?.coherenceCohesionFeedback"></p>
                        </template>
                        <template x-if="selectedScore === 'lr'">
                            <p x-text="results.bandScores?.lexicalResourceFeedback"></p>
                        </template>
                        <template x-if="selectedScore === 'gr'">
                            <p x-text="results.bandScores?.grammaticalRangeFeedback"></p>
                        </template>
                    </div>

                    <!-- Summary Stats -->
                    <div class="summary-stats">
                        <div class="stat-item">
                            <div class="stat-value errors" x-text="results.summary?.totalErrors || 0"></div>
                            <div class="stat-label">Errors</div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-value vocab" x-text="results.summary?.vocabularyUpgrades || 0"></div>
                            <div class="stat-label">Vocab Tips</div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-value grammar" x-text="results.summary?.grammarImprovements || 0"></div>
                            <div class="stat-label">Grammar Tips</div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-value level" x-text="results.summary?.estimatedCurrentLevel || '-'"></div>
                            <div class="stat-label">Level</div>
                        </div>
                    </div>

                    <!-- Tabs -->
                    <div class="tabs">
                        <button class="tab-btn" :class="{ 'active': activeTab === 'improved' }"
                            @click="activeTab = 'improved'">Improved Essay</button>
                        <button class="tab-btn" :class="{ 'active': activeTab === 'errors' }"
                            @click="activeTab = 'errors'">Errors</button>
                        <button class="tab-btn" :class="{ 'active': activeTab === 'vocabulary' }"
                            @click="activeTab = 'vocabulary'">Vocabulary</button>
                        <button class="tab-btn" :class="{ 'active': activeTab === 'keypoints' }"
                            @click="activeTab = 'keypoints'">Key Points</button>
                        <button class="tab-btn" :class="{ 'active': activeTab === 'paragraphs' }"
                            @click="activeTab = 'paragraphs'">Paragraphs</button>
                    </div>

                    <!-- Tab: Improved Essay -->
                    <div class="tab-content" :class="{ 'active': activeTab === 'improved' }">
                        <div style="display: flex; justify-content: flex-end; margin-bottom: 12px;">
                            <button class="copy-btn" @click="copyImprovedEssay()">
                                Copy Improved Essay
                            </button>
                        </div>
                        <div class="improved-essay" x-text="results.improvedEssay || 'No improved essay available'">
                        </div>
                    </div>

                    <!-- Tab: Errors -->
                    <div class="tab-content" :class="{ 'active': activeTab === 'errors' }">
                        <template x-for="(error, index) in results.errors || []" :key="index">
                            <div class="correction-item error">
                                <div class="correction-type error">
                                    <span x-text="error.type?.replace('_', ' ')"></span>
                                </div>
                                <div>
                                    <span class="correction-original" x-text="error.original"></span>
                                    <span class="correction-arrow">&rarr;</span>
                                    <span class="correction-new" x-text="error.correction"></span>
                                </div>
                                <div class="correction-explanation">
                                    <strong>Why:</strong> <span x-text="error.explanation"></span>
                                    <template x-if="error.rule">
                                        <span><br><strong>Rule:</strong> <span x-text="error.rule"></span></span>
                                    </template>
                                </div>
                            </div>
                        </template>
                        <div x-show="!results.errors?.length"
                            style="text-align: center; padding: 40px; color: rgba(255,255,255,0.5);">
                            No errors found - great job!
                        </div>
                    </div>

                    <!-- Tab: Vocabulary -->
                    <div class="tab-content" :class="{ 'active': activeTab === 'vocabulary' }">
                        <template x-for="(vocab, index) in results.vocabularyUpgrades || []" :key="index">
                            <div class="correction-item vocabulary">
                                <div class="correction-type vocabulary">Vocabulary Upgrade</div>
                                <div>
                                    <span class="correction-original" x-text="vocab.original"></span>
                                    <span class="correction-arrow">&rarr;</span>
                                    <span class="correction-new" x-text="vocab.upgraded"></span>
                                </div>
                                <div class="correction-explanation">
                                    <span x-text="vocab.explanation"></span>
                                    <template x-if="vocab.alternatives?.length">
                                        <span><br><strong>Alternatives:</strong> <span
                                                x-text="vocab.alternatives.join(', ')"></span></span>
                                    </template>
                                </div>
                            </div>
                        </template>

                        <h4 style="margin: 24px 0 16px; color: rgba(255,255,255,0.8);">Grammar Improvements</h4>
                        <template x-for="(gram, index) in results.grammarImprovements || []" :key="index">
                            <div class="correction-item grammar">
                                <div class="correction-type grammar" x-text="gram.technique || 'Grammar'"></div>
                                <div>
                                    <span class="correction-original" x-text="gram.original"></span>
                                    <span class="correction-arrow">&rarr;</span>
                                    <span class="correction-new" x-text="gram.improved"></span>
                                </div>
                                <div class="correction-explanation" x-text="gram.explanation"></div>
                            </div>
                        </template>
                    </div>

                    <!-- Tab: Key Points -->
                    <div class="tab-content" :class="{ 'active': activeTab === 'keypoints' }">
                        <template x-for="(point, index) in results.keyImprovementPoints || []" :key="index">
                            <div class="key-point">
                                <div class="key-point-area" x-text="point.area"></div>
                                <div class="key-point-title" x-text="point.point"></div>
                                <template x-if="point.examples">
                                    <p style="font-size: 0.85rem; color: rgba(255,255,255,0.6);">
                                        <strong>Example:</strong> <span x-text="point.examples"></span>
                                    </p>
                                </template>
                                <template x-if="point.practice">
                                    <div class="key-point-practice">
                                        <strong>Practice:</strong> <span x-text="point.practice"></span>
                                    </div>
                                </template>
                            </div>
                        </template>

                        <!-- Strengths & Weaknesses -->
                        <div class="feedback-grid">
                            <div class="feedback-box strengths">
                                <div class="feedback-box-title">
                                    <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                                        stroke-width="2">
                                        <path d="M22 11.08V12a10 10 0 1 1-5.93-9.14" />
                                        <polyline points="22 4 12 14.01 9 11.01" />
                                    </svg>
                                    Strengths
                                </div>
                                <ul class="feedback-list">
                                    <template x-for="strength in results.strengths || []" :key="strength">
                                        <li x-text="strength"></li>
                                    </template>
                                </ul>
                            </div>
                            <div class="feedback-box weaknesses">
                                <div class="feedback-box-title">
                                    <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                                        stroke-width="2">
                                        <circle cx="12" cy="12" r="10" />
                                        <line x1="12" y1="8" x2="12" y2="12" />
                                        <line x1="12" y1="16" x2="12.01" y2="16" />
                                    </svg>
                                    Areas to Improve
                                </div>
                                <ul class="feedback-list">
                                    <li x-text="results.summary?.mainFocus || 'Keep practicing!'"></li>
                                </ul>
                            </div>
                        </div>
                    </div>

                    <!-- Tab: Paragraphs -->
                    <div class="tab-content" :class="{ 'active': activeTab === 'paragraphs' }">
                        <template x-for="(para, index) in results.paragraphFeedback || []" :key="index">
                            <div class="paragraph-feedback">
                                <div class="paragraph-header">
                                    <span style="font-weight: 600;">Paragraph <span
                                            x-text="para.paragraphNumber"></span></span>
                                    <div style="display: flex; gap: 8px;">
                                        <span class="paragraph-type" x-text="para.type"></span>
                                        <span class="topic-sentence-badge"
                                            :class="para.topicSentence?.toLowerCase().replace(' ', '-')"
                                            x-text="'Topic: ' + para.topicSentence"></span>
                                    </div>
                                </div>
                                <p style="font-size: 0.9rem; color: rgba(255,255,255,0.8);" x-text="para.feedback"></p>
                                <template x-if="para.topicSentenceSuggestion">
                                    <p style="font-size: 0.85rem; color: #22c55e; margin-top: 10px;">
                                        <strong>Suggested topic sentence:</strong> <span
                                            x-text="para.topicSentenceSuggestion"></span>
                                    </p>
                                </template>
                                <div class="cohesive-devices">
                                    <template x-for="device in para.cohesiveDevices || []" :key="device">
                                        <span class="device-tag" x-text="device"></span>
                                    </template>
                                    <template x-for="device in para.suggestedDevices || []" :key="device">
                                        <span class="device-tag suggested" x-text="'+ ' + device"></span>
                                    </template>
                                </div>
                            </div>
                        </template>
                    </div>
                </div>

                <!-- No Results Yet -->
                <div class="card" x-show="!hasResults">
                    <div class="no-results">
                        <svg width="60" height="60" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                            stroke-width="1" style="margin: 0 auto 20px;">
                            <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z" />
                            <polyline points="14 2 14 8 20 8" />
                            <line x1="16" y1="13" x2="8" y2="13" />
                            <line x1="16" y1="17" x2="8" y2="17" />
                        </svg>
                        <p style="font-size: 1.1rem; margin-bottom: 8px;">Ready to assess your essay</p>
                        <p style="font-size: 0.9rem;">Enter your essay and click "Send to AI Examiner" to get detailed
                            feedback</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        function writingAssessment() {
            return {
                essay: '',
                essayQuestion: '',
                apiKey: localStorage.getItem('openai_api_key') || '',
                taskType: 'task2',
                isLoading: false,
                hasResults: false,
                activeTab: 'improved',
                selectedScore: null,
                results: {},

                get wordCount() {
                    return this.essay.trim().split(/\s+/).filter(word => word.length > 0).length;
                },

                get minWords() {
                    return this.taskType === 'task2' ? 250 : 150;
                },

                get canSubmit() {
                    return this.essay.trim().length > 0 && this.apiKey.trim().length > 0;
                },

                saveApiKey() {
                    localStorage.setItem('openai_api_key', this.apiKey);
                },

                copyImprovedEssay() {
                    if (this.results.improvedEssay) {
                        navigator.clipboard.writeText(this.results.improvedEssay);
                        alert('Improved essay copied to clipboard!');
                    }
                },

                async assessEssay() {
                    if (!this.canSubmit) return;

                    this.isLoading = true;
                    this.hasResults = false;
                    this.selectedScore = null;

                    // Task-specific criteria
                    const taskCriteria = this.taskType === 'task2' ? `
## TASK 2 SPECIFIC REQUIREMENTS
- Clear position throughout the response
- Main ideas extended and supported with relevant examples
- All parts of the prompt addressed
- Minimum 250 words (penalize if under)
- 4-5 paragraph structure expected (intro, 2-3 body, conclusion)` : `
## TASK 1 SPECIFIC REQUIREMENTS
- Clear overview of main trends/features (CRITICAL - Band 7+ requires this)
- Key features selected and described accurately
- Data/process described with precision
- Comparison and contrast where relevant
- Minimum 150 words (penalize if under)
- NO personal opinion (this is a report, not an essay)
- 3-4 paragraph structure (intro with overview, 2-3 body paragraphs)`;

                    const systemPrompt = `You are a Senior IELTS Writing Examiner and band score calibrator with 20+ years of experience. You have trained other examiners and your assessments are used as benchmarks.

## YOUR ROLE
Assess this IELTS ${this.taskType === 'task2' ? 'Task 2 Essay' : 'Task 1 Report'} using the OFFICIAL IELTS band descriptors below. Be precise and consistent.

${taskCriteria}

## OFFICIAL IELTS BAND DESCRIPTORS

### TASK ACHIEVEMENT / TASK RESPONSE
**Band 9**: Fully addresses all parts with a fully developed position. Ideas are relevant, fully extended and well supported.
**Band 8**: Sufficiently addresses all parts. Presents a well-developed response with relevant, extended and supported ideas.
**Band 7**: Addresses all parts. Presents a clear position throughout. Main ideas are extended and supported but there may be a tendency to over-generalize or lack focus.
**Band 6**: Addresses all parts though some parts may be more fully covered than others. Presents a relevant position but conclusions may be unclear or repetitive. Main ideas are relevant but some may be inadequately developed or unclear.
**Band 5**: Addresses the task only partially. Format may be inappropriate in places. Position is not always clear. Main ideas are limited and not sufficiently developed; irrelevant detail may be present.

### COHERENCE AND COHESION
**Band 9**: Uses cohesion in such a way that it attracts no attention. Skilfully manages paragraphing.
**Band 8**: Sequences information and ideas logically. Manages all aspects of cohesion well. Uses paragraphing sufficiently and appropriately.
**Band 7**: Logically organizes information and ideas; clear progression throughout. Uses a range of cohesive devices appropriately although there may be some under/over-use. Presents a clear central topic within each paragraph.
**Band 6**: Arranges information coherently and there is clear overall progression. Uses cohesive devices effectively but cohesion within/between sentences may be faulty or mechanical. May not always use referencing clearly or appropriately.
**Band 5**: Presents information with some organization but no overall progression. Uses cohesive devices but not always appropriately. May be repetitive. Paragraphing may be inadequate.

### LEXICAL RESOURCE
**Band 9**: Uses a wide range of vocabulary with very natural and sophisticated control of lexical features; rare minor errors occur only as 'slips'.
**Band 8**: Uses a wide range of vocabulary fluently and flexibly. Skilfully uses uncommon lexical items with occasional inaccuracies in word choice and collocation. Rare errors in spelling/word formation.
**Band 7**: Uses a sufficient range of vocabulary to allow some flexibility and precision. Uses less common lexical items with some awareness of style and collocation. May produce occasional errors in word choice, spelling and/or word formation.
**Band 6**: Uses an adequate range of vocabulary for the task. Attempts to use less common vocabulary but with some inaccuracy. Makes some errors in spelling and/or word formation but they do not impede communication.
**Band 5**: Uses a limited range of vocabulary, but minimally adequate for the task. May make noticeable errors in spelling and/or word formation that may cause some difficulty for the reader.

### GRAMMATICAL RANGE AND ACCURACY
**Band 9**: Uses a wide range of structures with full flexibility and accuracy; rare minor errors occur only as 'slips'.
**Band 8**: Uses a wide range of structures. Most sentences are error-free. Makes only very occasional errors or inappropriacies.
**Band 7**: Uses a variety of complex structures. Produces frequent error-free sentences. Has good control of grammar and punctuation but may make a few errors.
**Band 6**: Uses a mix of simple and complex sentence forms. Makes some errors in grammar and punctuation but they rarely reduce communication.
**Band 5**: Uses only a limited range of structures. Attempts complex sentences but these tend to be less accurate than simple sentences. May make frequent grammatical errors; punctuation may be faulty.

## SCORING CALIBRATION GUIDANCE

**Be strict but fair.** Most IELTS candidates score between 5.5-7.0. Here's how to calibrate:

- **Band 7.0+**: Reserved for essays with clear strengths across all criteria. Few errors, good vocabulary range, clear organization.
- **Band 6.0-6.5**: The "competent" range. Essay communicates effectively but has noticeable weaknesses. Some vocabulary attempts, some grammatical errors.
- **Band 5.0-5.5**: Basic competence. Message gets across but with limitations. Repetitive vocabulary, frequent errors, weak organization.
- **Below 5.0**: Significant difficulties. Hard to follow, many errors impeding communication.

**Common scoring mistakes to avoid:**
- Don't inflate scores for "good effort" - assess what's actually written
- Don't penalize too harshly for a few errors if overall communication is effective
- Band 6.5 is NOT "average" - it represents competent English
- Word count matters: Under minimum = automatic ceiling of Band 6 for Task Achievement

## ERROR ANALYSIS REQUIREMENTS
Identify ALL errors in these categories:
- **Article errors**: missing/wrong a/an/the
- **Subject-verb agreement**: singular/plural mismatches
- **Tense errors**: wrong tense or tense inconsistency
- **Word form**: wrong part of speech (noun/verb/adj/adv)
- **Word choice**: wrong word or collocation error
- **Preposition**: wrong or missing preposition
- **Punctuation**: comma splices, run-ons, missing commas
- **Spelling**: misspelled words
- **Structure**: awkward or incorrect sentence structure

## VOCABULARY UPGRADE REQUIREMENTS
Identify EVERY basic/overused word and provide academic alternatives:
- good/nice → beneficial, advantageous, favorable, positive
- bad → detrimental, adverse, harmful, negative
- important → crucial, vital, essential, significant, paramount
- very → highly, extremely, considerably, remarkably
- show → demonstrate, illustrate, indicate, reveal
- think/believe → argue, contend, maintain, assert
- a lot of/many → numerous, considerable, substantial, extensive
- get → obtain, acquire, gain, receive
- big/large → substantial, significant, considerable, extensive
- problem → issue, challenge, concern, difficulty
- people → individuals, citizens, population, members of society
- thing → aspect, factor, element, component
- use → utilize, employ, implement, apply
- make → create, generate, produce, establish
- way → method, approach, means, manner

## GRAMMAR IMPROVEMENTS REQUIREMENTS
For each grammar improvement, explain CLEARLY:
1. **Original**: The exact sentence from the essay
2. **Improved**: The corrected/enhanced version
3. **Technique**: Name the specific grammar technique used (e.g., "Passive voice", "Complex sentence with subordinate clause", "Inversion for emphasis", "Nominalization", "Reduced relative clause")
4. **Explanation**: Explain in simple terms:
   - WHAT was changed
   - WHY this change improves the writing
   - HOW it affects the band score (e.g., "Shows grammatical range needed for Band 7+")

Example format:
{
  "original": "Many people think that technology is good.",
  "improved": "It is widely believed that technology offers significant benefits.",
  "technique": "Impersonal passive construction",
  "explanation": "Changed from simple 'people think' to impersonal passive 'it is widely believed'. This is more academic and formal, avoids overusing 'people' (a basic word), and demonstrates grammatical range. IELTS examiners look for passive constructions as evidence of Band 7+ grammar."
}

Another example:
{
  "original": "Because technology is developing fast, our lives change.",
  "improved": "Due to the rapid advancement of technology, our lives are undergoing significant transformation.",
  "technique": "Nominalization with prepositional phrase",
  "explanation": "Changed the 'because' clause to a prepositional phrase 'Due to'. Converted verbs to nouns ('developing' → 'advancement', 'change' → 'transformation'). This is called nominalization - a key feature of academic writing that demonstrates lexical and grammatical sophistication required for Band 7+."
}

Focus on improvements that demonstrate:
- Complex sentence structures (relative clauses, conditionals, concessive clauses)
- Passive voice for objectivity
- Nominalization (turning verbs into nouns)
- Inversion for emphasis
- It-cleft and What-cleft sentences
- Participle clauses

## IMPROVED ESSAY REQUIREMENTS
Rewrite maintaining the EXACT same argument and ideas, but with:
- All errors corrected
- Basic vocabulary upgraded to academic alternatives
- Simple sentences combined into complex structures where appropriate
- Better paragraph transitions and cohesive devices
- Aim for approximately 0.5-1.0 band improvement potential

## KEY IMPROVEMENT POINTS REQUIREMENTS
For each improvement point, you MUST include:
1. **Area**: Grammar, Vocabulary, Coherence, Task Achievement, or Structure
2. **Point**: Clear, specific advice (not vague like "improve grammar")
3. **Examples**: Quote 2-3 ACTUAL sentences/phrases from the student's essay that demonstrate this issue
4. **Practice**: A specific exercise or tip to improve this area

Example format:
{
  "area": "Grammar",
  "point": "Improve article usage with countable/uncountable nouns",
  "examples": "From your essay: 'Education is important for success' (missing 'the'), 'I have informations' (uncountable noun error), 'The life is difficult' (unnecessary article)",
  "practice": "Create a list of 20 common uncountable nouns (information, advice, knowledge, research) and practice writing sentences without articles. Review the rules: use 'the' for specific things, 'a/an' for general countable nouns, no article for uncountable nouns in general statements."
}

Provide 5-7 key improvement points, prioritized by impact on band score.

## OUTPUT REQUIREMENTS
Provide detailed, actionable feedback. Be specific with examples from the essay. The goal is to help this student improve to the next band level.`;

                    const userPrompt = this.essayQuestion
                        ? `## ESSAY QUESTION/PROMPT:\n${this.essayQuestion}\n\n## STUDENT'S ${this.taskType === 'task2' ? 'ESSAY' : 'REPORT'} (${this.wordCount} words):\n${this.essay}`
                        : `## STUDENT'S IELTS ${this.taskType === 'task2' ? 'Task 2 Essay' : 'Task 1 Report'} (${this.wordCount} words):\n${this.essay}`;

                    // JSON Schema for structured output
                    const jsonSchema = {
                        type: "json_schema",
                        json_schema: {
                            name: "ielts_assessment",
                            strict: true,
                            schema: {
                                type: "object",
                                properties: {
                                    taskType: { type: "string", enum: ["task1", "task2"] },
                                    wordCount: { type: "integer" },
                                    isMinimumMet: { type: "boolean" },
                                    bandScores: {
                                        type: "object",
                                        properties: {
                                            taskAchievement: { type: "number" },
                                            taskAchievementFeedback: { type: "string" },
                                            coherenceCohesion: { type: "number" },
                                            coherenceCohesionFeedback: { type: "string" },
                                            lexicalResource: { type: "number" },
                                            lexicalResourceFeedback: { type: "string" },
                                            grammaticalRange: { type: "number" },
                                            grammaticalRangeFeedback: { type: "string" },
                                            overall: { type: "number" }
                                        },
                                        required: ["taskAchievement", "taskAchievementFeedback", "coherenceCohesion", "coherenceCohesionFeedback", "lexicalResource", "lexicalResourceFeedback", "grammaticalRange", "grammaticalRangeFeedback", "overall"],
                                        additionalProperties: false
                                    },
                                    errors: {
                                        type: "array",
                                        items: {
                                            type: "object",
                                            properties: {
                                                type: { type: "string" },
                                                original: { type: "string" },
                                                correction: { type: "string" },
                                                explanation: { type: "string" },
                                                rule: { type: "string" }
                                            },
                                            required: ["type", "original", "correction", "explanation", "rule"],
                                            additionalProperties: false
                                        }
                                    },
                                    vocabularyUpgrades: {
                                        type: "array",
                                        items: {
                                            type: "object",
                                            properties: {
                                                original: { type: "string" },
                                                upgraded: { type: "string" },
                                                explanation: { type: "string" },
                                                alternatives: { type: "array", items: { type: "string" } }
                                            },
                                            required: ["original", "upgraded", "explanation", "alternatives"],
                                            additionalProperties: false
                                        }
                                    },
                                    grammarImprovements: {
                                        type: "array",
                                        items: {
                                            type: "object",
                                            properties: {
                                                original: { type: "string" },
                                                improved: { type: "string" },
                                                technique: { type: "string" },
                                                explanation: { type: "string" }
                                            },
                                            required: ["original", "improved", "technique", "explanation"],
                                            additionalProperties: false
                                        }
                                    },
                                    improvedEssay: { type: "string" },
                                    keyImprovementPoints: {
                                        type: "array",
                                        items: {
                                            type: "object",
                                            properties: {
                                                area: { type: "string" },
                                                point: { type: "string" },
                                                examples: { type: "string" },
                                                practice: { type: "string" }
                                            },
                                            required: ["area", "point", "examples", "practice"],
                                            additionalProperties: false
                                        }
                                    },
                                    paragraphFeedback: {
                                        type: "array",
                                        items: {
                                            type: "object",
                                            properties: {
                                                paragraphNumber: { type: "integer" },
                                                type: { type: "string" },
                                                topicSentence: { type: "string", enum: ["good", "needs improvement", "missing"] },
                                                topicSentenceSuggestion: { type: "string" },
                                                cohesiveDevices: { type: "array", items: { type: "string" } },
                                                suggestedDevices: { type: "array", items: { type: "string" } },
                                                feedback: { type: "string" }
                                            },
                                            required: ["paragraphNumber", "type", "topicSentence", "topicSentenceSuggestion", "cohesiveDevices", "suggestedDevices", "feedback"],
                                            additionalProperties: false
                                        }
                                    },
                                    strengths: { type: "array", items: { type: "string" } },
                                    summary: {
                                        type: "object",
                                        properties: {
                                            totalErrors: { type: "integer" },
                                            vocabularyUpgrades: { type: "integer" },
                                            grammarImprovements: { type: "integer" },
                                            estimatedCurrentLevel: { type: "string", enum: ["A2", "B1", "B2", "C1"] },
                                            mainFocus: { type: "string" }
                                        },
                                        required: ["totalErrors", "vocabularyUpgrades", "grammarImprovements", "estimatedCurrentLevel", "mainFocus"],
                                        additionalProperties: false
                                    }
                                },
                                required: ["taskType", "wordCount", "isMinimumMet", "bandScores", "errors", "vocabularyUpgrades", "grammarImprovements", "improvedEssay", "keyImprovementPoints", "paragraphFeedback", "strengths", "summary"],
                                additionalProperties: false
                            }
                        }
                    };

                    try {
                        const response = await fetch('https://api.openai.com/v1/chat/completions', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                                'Authorization': `Bearer ${this.apiKey}`
                            },
                            body: JSON.stringify({
                                model: 'gpt-4o',
                                messages: [
                                    { role: 'system', content: systemPrompt },
                                    { role: 'user', content: userPrompt }
                                ],
                                response_format: jsonSchema,
                                temperature: 0.3,
                                max_tokens: 12000
                            })
                        });

                        if (!response.ok) {
                            const error = await response.json();
                            throw new Error(error.error?.message || 'API request failed');
                        }

                        const data = await response.json();
                        const content = data.choices[0].message.content;

                        // With structured output, response is guaranteed valid JSON
                        this.results = JSON.parse(content);
                        this.hasResults = true;
                    } catch (error) {
                        console.error('Assessment error:', error);
                        alert('Error: ' + error.message);
                    } finally {
                        this.isLoading = false;
                    }
                }
            };
        }
    </script>
</body>

</html>