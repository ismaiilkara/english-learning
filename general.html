<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>IELTS General Training - English Learning Hub</title>
    <link rel="icon" type="image/x-icon" href="icon/favicon.ico">
    <link rel="icon" type="image/png" sizes="32x32" href="icon/favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="icon/favicon-16x16.png">
    <link rel="apple-touch-icon" sizes="180x180" href="icon/apple-touch-icon.png">
    <script src="https://cdn.tailwindcss.com"></script>
    <script defer src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=DM+Sans:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        [x-cloak] {
            display: none !important;
        }

        * {
            font-family: 'DM Sans', sans-serif;
        }

        html,
        body {
            background: linear-gradient(135deg, #0a0a0a 0%, #1a1a1a 50%, #0d0d0d 100%);
            min-height: 100vh;
        }

        body.no-scroll {
            overflow: hidden;
            height: 100vh;
        }

        .glass-card {
            background: rgba(255, 255, 255, 0.03);
            backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.08);
        }

        .section-btn {
            transition: all 0.3s ease;
        }

        .section-btn:hover {
            transform: translateY(-4px);
        }

        .passage-text {
            line-height: 1.9;
        }

        .passage-text p {
            margin-bottom: 1.25rem;
        }

        /* Hide answer highlights in passages */
        .passage-text strong {
            font-weight: normal;
        }

        .paragraph-label {
            color: #f472b6;
            font-weight: bold;
            margin-right: 0.5rem;
        }

        .question-card {
            background: rgba(255, 255, 255, 0.04);
            border: 1px solid rgba(255, 255, 255, 0.08);
        }

        .radio-option:hover {
            background: rgba(255, 255, 255, 0.08);
        }

        .radio-option.selected {
            background: rgba(236, 72, 153, 0.2);
            border-color: #ec4899;
        }

        .radio-option.correct {
            background: rgba(34, 197, 94, 0.2) !important;
            border-color: #22c55e !important;
        }

        .radio-option.incorrect {
            background: rgba(239, 68, 68, 0.2) !important;
            border-color: #ef4444 !important;
        }

        .fill-input {
            background: rgba(0, 0, 0, 0.3);
            border: 2px solid rgba(255, 255, 255, 0.15);
        }

        .fill-input:focus {
            border-color: #ec4899;
            outline: none;
        }

        .fill-input.correct {
            border-color: #22c55e !important;
            background: rgba(34, 197, 94, 0.1) !important;
        }

        .fill-input.incorrect {
            border-color: #ef4444 !important;
            background: rgba(239, 68, 68, 0.1) !important;
        }

        ::-webkit-scrollbar {
            width: 6px;
        }

        ::-webkit-scrollbar-track {
            background: rgba(255, 255, 255, 0.02);
        }

        ::-webkit-scrollbar-thumb {
            background: rgba(255, 255, 255, 0.15);
            border-radius: 3px;
        }

        .fade-in {
            animation: fadeIn 0.4s ease-out;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        /* Mobile Responsive */
        @media (max-width: 768px) {
            .section-btn:hover {
                transform: none;
            }
        }
    </style>
</head>

<body class="text-white" x-data="ieltsApp()" x-cloak>

    <!-- Loading state when no test selected -->
    <div x-show="currentView === 'list'" class="min-h-screen flex items-center justify-center">
        <div class="text-center">
            <div class="text-6xl mb-4">üìã</div>
            <h2 class="text-2xl font-bold text-white mb-4">IELTS General Training</h2>
            <p class="text-white/50 mb-6">Test se√ßmek i√ßin ana sayfaya gidin</p>
            <a href="ielts.html"
                class="bg-green-500 hover:bg-green-600 text-white font-bold py-3 px-8 rounded-xl transition-all">
                ‚Üê Testlere D√∂n
            </a>
        </div>
    </div>


    <!-- ==================== READING SECTION VIEW ==================== -->
    <div x-show="currentView === 'reading'" class="h-screen flex flex-col overflow-hidden">

        <!-- Header -->
        <header class="glass-card flex-shrink-0 z-50">
            <div
                class="max-w-7xl mx-auto px-3 md:px-6 py-3 md:py-4 flex flex-col md:flex-row items-center gap-3 md:justify-between">
                <div class="flex items-center justify-between w-full md:w-auto">
                    <button @click="window.location.href = 'ielts.html'"
                        class="flex items-center gap-2 text-white/60 hover:text-white transition-colors">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7" />
                        </svg>
                        <span class="hidden sm:inline">Testlere D√∂n</span>
                    </button>
                    <div class="text-gray-400 font-semibold md:hidden">üìñ Reading</div>
                </div>

                <div class="flex flex-col sm:flex-row items-center gap-2 md:gap-4 w-full md:w-auto">
                    <span class="text-white font-semibold text-sm md:text-base hidden md:block">
                        <span x-text="currentTestData?.name"></span>
                        <span class="text-white/50"> - Reading</span>
                        <span x-show="currentTestData?.type === 'general'"
                            class="ml-2 bg-green-500/20 text-green-400 text-xs px-2 py-0.5 rounded">GT</span>
                    </span>
                    <div class="flex gap-2 flex-wrap justify-center">
                        <template x-for="(passage, index) in currentPassages" :key="index">
                            <button @click="currentPassageIndex = index; loadPassage(); showPassagePanel = true"
                                :class="currentPassageIndex === index ? 'bg-gray-500 text-white' : 'bg-white/10 hover:bg-white/20 text-white/70'"
                                class="px-3 md:px-4 py-1.5 md:py-2 rounded-lg font-semibold transition-all text-xs md:text-sm">
                                <span x-show="!passage.sectionNumber" x-text="'Passage ' + (index + 1)"></span>
                                <span x-show="passage.sectionNumber"
                                    x-text="'S' + passage.sectionNumber + '-' + passage.id"></span>
                            </button>
                        </template>
                    </div>
                </div>

                <div class="flex items-center gap-3">
                    <!-- Timer -->
                    <div class="flex items-center gap-2 bg-white/10 rounded-lg px-3 py-1.5">
                        <span class="text-white font-mono text-sm" x-text="formatTimer(readingTimer)"></span>
                        <button @click="toggleReadingTimer()"
                            :class="readingTimerRunning ? 'bg-yellow-500 hover:bg-yellow-600' : 'bg-green-500 hover:bg-green-600'"
                            class="text-white text-xs px-2 py-1 rounded transition-all">
                            <span x-text="readingTimerRunning ? '‚è∏' : '‚ñ∂'"></span>
                        </button>
                        <button @click="resetReadingTimer()"
                            class="bg-red-500/50 hover:bg-red-500 text-white text-xs px-2 py-1 rounded transition-all">
                            ‚Ü∫
                        </button>
                    </div>
                    <div class="text-gray-400 font-semibold hidden md:block">üìñ Reading</div>
                </div>
            </div>

            <!-- Mobile Panel Toggle -->
            <div class="md:hidden flex border-t border-white/10">
                <button @click="showPassagePanel = true"
                    :class="showPassagePanel ? 'bg-gray-500/20 text-gray-400 border-b-2 border-gray-500' : 'text-white/60'"
                    class="flex-1 py-2 text-sm font-medium transition-all">
                    üìñ Passage
                </button>
                <button @click="showPassagePanel = false"
                    :class="!showPassagePanel ? 'bg-yellow-500/20 text-yellow-400 border-b-2 border-yellow-500' : 'text-white/60'"
                    class="flex-1 py-2 text-sm font-medium transition-all">
                    ‚ùì Questions
                </button>
            </div>
        </header>

        <!-- Content -->
        <div class="flex flex-1 min-h-0">

            <!-- Left Panel - Passage -->
            <div class="w-full md:w-1/2 h-full overflow-y-auto border-r border-white/10"
                :class="{'hidden md:block': !showPassagePanel}">
                <div class="p-4 md:p-6">
                    <div class="glass-card rounded-2xl p-4 md:p-6">
                        <h2 class="text-xl md:text-2xl font-bold mb-3 md:mb-4 text-gray-400"
                            x-text="currentPassage?.title"></h2>
                        <p class="text-white/50 text-xs md:text-sm mb-4 md:mb-6 italic"
                            x-text="currentPassage?.subtitle"></p>

                        <!-- Standard content (HTML string) -->
                        <template x-if="currentPassage?.content">
                            <div class="passage-text text-white/85 text-sm md:text-[15px]"
                                x-html="currentPassage?.content"></div>
                        </template>

                        <!-- Paragraphs (for passages with labeled sections like A, B, C) -->
                        <template x-if="currentPassage?.paragraphs">
                            <div class="passage-text text-white/85 text-sm md:text-[15px] space-y-4">
                                <template x-for="para in currentPassage.paragraphs" :key="para.label">
                                    <div class="mb-4">
                                        <span class="text-gray-400 font-bold text-lg mr-2" x-text="para.label"></span>
                                        <span x-text="para.content"></span>
                                    </div>
                                </template>
                            </div>
                        </template>
                    </div>
                </div>
            </div>

            <!-- Right Panel - Questions -->
            <div class="w-full md:w-1/2 h-full overflow-y-auto" :class="{'hidden md:block': showPassagePanel}">
                <div class="p-4 md:p-6 space-y-4 md:space-y-6">
                    <template x-for="(section, sectionIndex) in currentPassage?.questions" :key="sectionIndex">
                        <div class="glass-card rounded-2xl p-6">

                            <!-- Section Header -->
                            <div class="mb-6">
                                <h3 class="text-lg font-bold text-yellow-400 mb-2" x-text="section.title"></h3>
                                <p class="text-white/50 text-sm" x-text="section.instructions"></p>
                            </div>

                            <!-- TRUE/FALSE/NOT GIVEN -->
                            <template x-if="section.type === 'tfng'">
                                <div class="space-y-4">
                                    <template x-for="q in section.items" :key="q.number">
                                        <div class="question-card rounded-xl p-4">
                                            <p class="text-white mb-3">
                                                <span class="text-gray-400 font-bold" x-text="q.number + '.'"></span>
                                                <span x-text="q.text"></span>
                                            </p>
                                            <div class="flex gap-2">
                                                <template x-for="option in ['TRUE', 'FALSE', 'NOT GIVEN']"
                                                    :key="option">
                                                    <button
                                                        @click="!passageSubmitted[currentPassageIndex] && setAnswer(q.number, option)"
                                                        :class="{
                                                        'selected': answers[q.number] === option && !passageSubmitted[currentPassageIndex],
                                                        'correct': passageSubmitted[currentPassageIndex] && q.answer === option,
                                                        'incorrect': passageSubmitted[currentPassageIndex] && answers[q.number] === option && q.answer !== option
                                                        }"
                                                        class="radio-option px-4 py-2 rounded-lg border border-white/20 text-sm font-medium transition-all"
                                                        :disabled="passageSubmitted[currentPassageIndex]">
                                                        <span x-text="option"></span>
                                                    </button>
                                                </template>
                                            </div>
                                        </div>
                                    </template>
                                </div>
                            </template>

                            <!-- YES/NO/NOT GIVEN -->
                            <template x-if="section.type === 'yesNoNotGiven'">
                                <div class="space-y-4">
                                    <template x-for="q in section.items" :key="q.number">
                                        <div class="question-card rounded-xl p-4">
                                            <p class="text-white mb-3">
                                                <span class="text-gray-400 font-bold" x-text="q.number + '.'"></span>
                                                <span x-text="q.text"></span>
                                            </p>
                                            <div class="flex gap-2">
                                                <template x-for="option in ['YES', 'NO', 'NOT GIVEN']" :key="option">
                                                    <button
                                                        @click="!passageSubmitted[currentPassageIndex] && setAnswer(q.number, option)"
                                                        :class="{
                                                            'selected': answers[q.number] === option && !passageSubmitted[currentPassageIndex],
                                                            'correct': passageSubmitted[currentPassageIndex] && q.answer === option,
                                                            'incorrect': passageSubmitted[currentPassageIndex] && answers[q.number] === option && q.answer !== option
                                                        }"
                                                        class="radio-option px-4 py-2 rounded-lg border border-white/20 text-sm font-medium transition-all"
                                                        :disabled="passageSubmitted[currentPassageIndex]">
                                                        <span x-text="option"></span>
                                                    </button>
                                                </template>
                                            </div>
                                        </div>
                                    </template>
                                </div>
                            </template>

                            <!-- MATCHING -->
                            <template x-if="section.type === 'matching'">
                                <div class="space-y-4">
                                    <!-- Option Labels Box (if available) -->
                                    <template x-if="section.optionLabels">
                                        <div class="bg-white/5 rounded-xl p-4 border border-white/10 mb-4">
                                            <p class="text-white/70 font-semibold mb-2"
                                                x-text="section.optionLabelsTitle || 'List of Options:'"></p>
                                            <template x-for="option in section.options" :key="option">
                                                <p class="text-white/60 mb-1">
                                                    <span class="text-gray-400 font-bold" x-text="option + '.'"></span>
                                                    <span x-text="section.optionLabels[option]"></span>
                                                </p>
                                            </template>
                                        </div>
                                    </template>
                                    <template x-for="q in section.items" :key="q.number">
                                        <div class="question-card rounded-xl p-4">
                                            <p class="text-white mb-3">
                                                <span class="text-gray-400 font-bold" x-text="q.number + '.'"></span>
                                                <span x-text="q.text || q.statement"></span>
                                            </p>
                                            <div class="flex gap-2 flex-wrap">
                                                <template x-for="option in section.options" :key="option">
                                                    <button
                                                        @click="!passageSubmitted[currentPassageIndex] && setAnswer(q.number, option)"
                                                        :class="{
                                                        'selected': answers[q.number] === option && !passageSubmitted[currentPassageIndex],
                                                        'correct': passageSubmitted[currentPassageIndex] && q.answer === option,
                                                        'incorrect': passageSubmitted[currentPassageIndex] && answers[q.number] === option && q.answer !== option
                                                        }"
                                                        class="radio-option px-3 py-2 rounded-lg border border-white/20 text-sm font-medium transition-all"
                                                        :disabled="passageSubmitted[currentPassageIndex]">
                                                        <span x-text="option"></span>
                                                    </button>
                                                </template>
                                            </div>
                                            <!-- Explanation -->
                                            <div x-show="passageSubmitted[currentPassageIndex] && q.explanation"
                                                class="mt-3 p-3 bg-blue-500/10 border border-blue-500/30 rounded-lg">
                                                <p class="text-blue-300 text-sm">
                                                    <span class="font-semibold">Explanation:</span>
                                                    <span x-text="q.explanation"></span>
                                                </p>
                                            </div>
                                        </div>
                                    </template>
                                </div>
                            </template>

                            <!-- MATCH PEOPLE -->
                            <template x-if="section.type === 'matchPeople'">
                                <div class="space-y-4">
                                    <div class="bg-white/5 rounded-xl p-4 border border-white/10 mb-4">
                                        <p class="text-white/70 font-semibold mb-2">List of People:</p>
                                        <template x-for="person in section.people" :key="person.letter">
                                            <p class="text-white/60">
                                                <span class="text-gray-400 font-bold"
                                                    x-text="person.letter + '.'"></span>
                                                <span x-text="person.name"></span>
                                            </p>
                                        </template>
                                    </div>
                                    <template x-for="q in section.items" :key="q.number">
                                        <div class="question-card rounded-xl p-4">
                                            <p class="text-white mb-3">
                                                <span class="text-gray-400 font-bold" x-text="q.number + '.'"></span>
                                                <span x-text="q.text"></span>
                                            </p>
                                            <div class="flex gap-2">
                                                <template x-for="person in section.people" :key="person.letter">
                                                    <button
                                                        @click="!passageSubmitted[currentPassageIndex] && setAnswer(q.number, person.letter)"
                                                        :class="{
                                                        'selected': answers[q.number] === person.letter && !passageSubmitted[currentPassageIndex],
                                                        'correct': passageSubmitted[currentPassageIndex] && q.answer === person.letter,
                                                        'incorrect': passageSubmitted[currentPassageIndex] && answers[q.number] === person.letter && q.answer !== person.letter
                                                        }"
                                                        class="radio-option px-4 py-2 rounded-lg border border-white/20 text-sm font-medium transition-all"
                                                        :disabled="passageSubmitted[currentPassageIndex]">
                                                        <span x-text="person.letter"></span>
                                                    </button>
                                                </template>
                                            </div>
                                        </div>
                                    </template>
                                </div>
                            </template>

                            <!-- NOTES COMPLETION -->
                            <template x-if="section.type === 'notes'">
                                <div class="bg-white/5 rounded-xl p-4 border border-white/10">
                                    <h4 class="text-lg font-semibold text-white mb-4" x-text="section.noteTitle"></h4>
                                    <div class="space-y-3">
                                        <template x-for="(item, itemIndex) in section.items" :key="itemIndex">
                                            <div>
                                                <template x-if="item.isHeader">
                                                    <p class="text-yellow-400 font-semibold mt-4 mb-2"
                                                        x-text="item.text"></p>
                                                </template>
                                                <template x-if="item.isSubHeader">
                                                    <p class="text-yellow-300/80 font-medium mt-2 mb-1 ml-2"
                                                        x-text="item.text"></p>
                                                </template>
                                                <template x-if="!item.isHeader && !item.isSubHeader">
                                                    <p class="text-white/85 flex items-center gap-2 flex-wrap">
                                                        <span>‚Ä¢</span>
                                                        <template x-for="(part, partIndex) in item.parts"
                                                            :key="partIndex">
                                                            <span>
                                                                <template x-if="part.type === 'text'">
                                                                    <span x-text="part.value"></span>
                                                                </template>
                                                                <template x-if="part.type === 'blank'">
                                                                    <span class="inline-flex items-center gap-1">
                                                                        <span class="text-gray-400 font-bold"
                                                                            x-text="part.number"></span>
                                                                        <input type="text"
                                                                            x-model="answers[part.number]"
                                                                            @input="currentTestId && localStorage.setItem(`reading_answers_test${currentTestId}`, JSON.stringify(answers))"
                                                                            :disabled="passageSubmitted[currentPassageIndex]"
                                                                            :class="{
                                                                                'correct': passageSubmitted[currentPassageIndex] && isCorrectFill(section, part.number),
                                                                                'incorrect': passageSubmitted[currentPassageIndex] && !isCorrectFill(section, part.number) && answers[part.number]
                                                                            }"
                                                                            class="fill-input w-32 px-3 py-1 rounded text-white text-center"
                                                                            placeholder="...">
                                                                        <span
                                                                            x-show="passageSubmitted[currentPassageIndex] && !isCorrectFill(section, part.number)"
                                                                            class="text-green-400 text-sm ml-1"
                                                                            x-text="'(' + section.answers[part.number] + ')'"></span>
                                                                    </span>
                                                                </template>
                                                            </span>
                                                        </template>
                                                    </p>
                                                </template>
                                            </div>
                                        </template>
                                    </div>
                                    <!-- Explanations for notes -->
                                    <template x-if="passageSubmitted[currentPassageIndex] && section.explanations">
                                        <div class="mt-4 pt-4 border-t border-white/10">
                                            <p class="text-blue-400 font-semibold mb-3">Explanations:</p>
                                            <div class="space-y-2">
                                                <template x-for="qNum in Object.keys(section.explanations)" :key="qNum">
                                                    <div class="p-2 bg-blue-500/10 border border-blue-500/30 rounded-lg">
                                                        <p class="text-blue-300 text-sm">
                                                            <span class="font-semibold" x-text="'Q' + qNum + ':'"></span>
                                                            <span x-text="section.explanations[qNum]"></span>
                                                        </p>
                                                    </div>
                                                </template>
                                            </div>
                                        </div>
                                    </template>
                                </div>
                            </template>

                            <!-- SUMMARY COMPLETION -->
                            <template x-if="section.type === 'summary'">
                                <div class="bg-white/5 rounded-xl p-4 border border-white/10">
                                    <h4 class="text-lg font-semibold text-white mb-4" x-text="section.summaryTitle">
                                    </h4>
                                    <p class="text-white/85 leading-relaxed">
                                        <template x-for="(part, partIndex) in section.parts" :key="partIndex">
                                            <span>
                                                <template x-if="part.type === 'text'">
                                                    <span x-text="part.value"></span>
                                                </template>
                                                <template x-if="part.type === 'blank'">
                                                    <span class="inline-flex items-center gap-1 mx-1">
                                                        <span class="text-gray-400 font-bold"
                                                            x-text="part.number"></span>
                                                        <input type="text" x-model="answers[part.number]"
                                                            @input="currentTestId && localStorage.setItem(`reading_answers_test${currentTestId}`, JSON.stringify(answers))"
                                                            :disabled="passageSubmitted[currentPassageIndex]" :class="{
                                                                'correct': passageSubmitted[currentPassageIndex] && isCorrectFill(section, part.number),
                                                                'incorrect': passageSubmitted[currentPassageIndex] && !isCorrectFill(section, part.number) && answers[part.number]
                                                            }"
                                                            class="fill-input w-28 px-3 py-1 rounded text-white text-center"
                                                            placeholder="...">
                                                        <span
                                                            x-show="passageSubmitted[currentPassageIndex] && !isCorrectFill(section, part.number)"
                                                            class="text-green-400 text-sm ml-1"
                                                            x-text="'(' + section.answers[part.number] + ')'"></span>
                                                    </span>
                                                </template>
                                            </span>
                                        </template>
                                    </p>
                                </div>
                            </template>

                            <!-- MULTIPLE CHOICE -->
                            <template x-if="section.type === 'multipleChoice'">
                                <div class="space-y-6">
                                    <template x-for="q in section.items" :key="q.number">
                                        <div class="question-card rounded-xl p-4">
                                            <p class="text-white mb-4">
                                                <span class="text-gray-400 font-bold" x-text="q.number + '.'"></span>
                                                <span x-text="q.text || q.question"></span>
                                            </p>
                                            <div class="space-y-2">
                                                <template x-for="option in q.options" :key="option.letter">
                                                    <button
                                                        @click="!passageSubmitted[currentPassageIndex] && setAnswer(q.number, option.letter)"
                                                        :class="{
                                                        'selected': answers[q.number] === option.letter && !passageSubmitted[currentPassageIndex],
                                                        'correct': passageSubmitted[currentPassageIndex] && q.answer === option.letter,
                                                        'incorrect': passageSubmitted[currentPassageIndex] && answers[q.number] === option.letter && q.answer !== option.letter
                                                        }"
                                                        class="radio-option w-full text-left px-4 py-3 rounded-lg border border-white/20 text-sm transition-all"
                                                        :disabled="passageSubmitted[currentPassageIndex]">
                                                        <span class="font-bold mr-2" x-text="option.letter"></span>
                                                        <span x-text="option.text"></span>
                                                    </button>
                                                </template>
                                            </div>
                                            <!-- Explanation -->
                                            <div x-show="passageSubmitted[currentPassageIndex] && q.explanation"
                                                class="mt-3 p-3 bg-blue-500/10 border border-blue-500/30 rounded-lg">
                                                <p class="text-blue-300 text-sm">
                                                    <span class="font-semibold">Explanation:</span>
                                                    <span x-text="q.explanation"></span>
                                                </p>
                                            </div>
                                        </div>
                                    </template>
                                </div>
                            </template>

                            <!-- SENTENCE COMPLETION (with endings) -->
                            <template x-if="section.type === 'sentenceCompletion' && section.endings">
                                <div class="space-y-4">
                                    <div class="bg-white/5 rounded-xl p-4 border border-white/10 mb-4">
                                        <p class="text-white/70 font-semibold mb-2">Sentence Endings:</p>
                                        <template x-for="ending in section.endings" :key="ending.letter">
                                            <p class="text-white/60 mb-1">
                                                <span class="text-gray-400 font-bold"
                                                    x-text="ending.letter + '.'"></span>
                                                <span x-text="ending.text"></span>
                                            </p>
                                        </template>
                                    </div>
                                    <template x-for="q in section.items" :key="q.number">
                                        <div class="question-card rounded-xl p-4">
                                            <p class="text-white mb-3">
                                                <span class="text-gray-400 font-bold" x-text="q.number + '.'"></span>
                                                <span x-text="q.text"></span>
                                            </p>
                                            <div class="flex gap-2 flex-wrap">
                                                <template x-for="ending in section.endings" :key="ending.letter">
                                                    <button
                                                        @click="!passageSubmitted[currentPassageIndex] && setAnswer(q.number, ending.letter)"
                                                        :class="{
                                                        'selected': answers[q.number] === ending.letter && !passageSubmitted[currentPassageIndex],
                                                        'correct': passageSubmitted[currentPassageIndex] && q.answer === ending.letter,
                                                        'incorrect': passageSubmitted[currentPassageIndex] && answers[q.number] === ending.letter && q.answer !== ending.letter
                                                        }"
                                                        class="radio-option px-4 py-2 rounded-lg border border-white/20 text-sm font-medium transition-all"
                                                        :disabled="passageSubmitted[currentPassageIndex]">
                                                        <span x-text="ending.letter"></span>
                                                    </button>
                                                </template>
                                            </div>
                                        </div>
                                    </template>
                                </div>
                            </template>

                            <!-- SENTENCE COMPLETION (fill in blank - GT) -->
                            <template x-if="section.type === 'sentenceCompletion' && !section.endings">
                                <div class="space-y-4">
                                    <template x-for="q in section.items" :key="q.number">
                                        <div class="question-card rounded-xl p-4">
                                            <div class="flex items-center gap-3 flex-wrap">
                                                <span class="text-gray-400 font-bold" x-text="q.number + '.'"></span>
                                                <span class="text-white"
                                                    x-text="q.textBefore || q.sentence || ''"></span>
                                                <input type="text" x-model="answers[q.number]"
                                                    :disabled="passageSubmitted[currentPassageIndex]"
                                                    @input="currentTestId && localStorage.setItem(`reading_answers_test${currentTestId}`, JSON.stringify(answers))"
                                                    :class="{
                                                            'correct': passageSubmitted[currentPassageIndex] && isCorrectFillItem(q.number, q.answer),
                                                            'incorrect': passageSubmitted[currentPassageIndex] && !isCorrectFillItem(q.number, q.answer) && answers[q.number]
                                                        }" class="fill-input w-36 px-3 py-2 rounded-lg text-white"
                                                    placeholder="...">
                                                <span class="text-white" x-text="q.textAfter || ''"></span>
                                                <span
                                                    x-show="passageSubmitted[currentPassageIndex] && !isCorrectFillItem(q.number, q.answer)"
                                                    class="text-green-400 text-sm" x-text="'(' + q.answer + ')'"></span>
                                            </div>
                                            <!-- Explanation -->
                                            <div x-show="passageSubmitted[currentPassageIndex] && q.explanation"
                                                class="mt-3 p-3 bg-blue-500/10 border border-blue-500/30 rounded-lg">
                                                <p class="text-blue-300 text-sm">
                                                    <span class="font-semibold">Explanation:</span>
                                                    <span x-text="q.explanation"></span>
                                                </p>
                                            </div>
                                        </div>
                                    </template>
                                </div>
                            </template>

                            <!-- TRUE/FALSE/NOT GIVEN (GT) -->
                            <template x-if="section.type === 'trueFalseNotGiven'">
                                <div class="space-y-4">
                                    <template x-for="q in section.items" :key="q.number">
                                        <div class="question-card rounded-xl p-4">
                                            <p class="text-white mb-3">
                                                <span class="text-gray-400 font-bold" x-text="q.number + '.'"></span>
                                                <span x-text="q.statement"></span>
                                            </p>
                                            <div class="flex gap-2 flex-wrap">
                                                <template x-for="option in ['TRUE', 'FALSE', 'NOT GIVEN']"
                                                    :key="option">
                                                    <button
                                                        @click="!passageSubmitted[currentPassageIndex] && setAnswer(q.number, option)"
                                                        :class="{
                                                        'selected': answers[q.number] === option && !passageSubmitted[currentPassageIndex],
                                                        'correct': passageSubmitted[currentPassageIndex] && q.answer === option,
                                                        'incorrect': passageSubmitted[currentPassageIndex] && answers[q.number] === option && q.answer !== option
                                                            }"
                                                        class="radio-option px-4 py-2 rounded-lg border border-white/20 text-sm font-medium transition-all"
                                                        :disabled="passageSubmitted[currentPassageIndex]">
                                                        <span x-text="option"></span>
                                                    </button>
                                                </template>
                                            </div>
                                            <!-- Explanation -->
                                            <div x-show="passageSubmitted[currentPassageIndex] && q.explanation"
                                                class="mt-3 p-3 bg-blue-500/10 border border-blue-500/30 rounded-lg">
                                                <p class="text-blue-300 text-sm">
                                                    <span class="font-semibold">Explanation:</span>
                                                    <span x-text="q.explanation"></span>
                                                </p>
                                            </div>
                                        </div>
                                    </template>
                                </div>
                            </template>

                            <!-- NOTE COMPLETION (GT) -->
                            <template x-if="section.type === 'noteCompletion'">
                                <div class="bg-white/5 rounded-xl p-4 border border-white/10">
                                    <h4 class="text-lg font-semibold text-white mb-4"
                                        x-text="section.noteTitle || section.title"></h4>
                                    <div class="space-y-3">
                                        <template x-for="q in section.items" :key="q.number">
                                            <div class="flex items-center gap-3 flex-wrap p-2 bg-white/5 rounded-lg">
                                                <span class="text-gray-400 font-bold" x-text="q.number + '.'"></span>
                                                <span class="text-white" x-text="q.textBefore || q.note || ''"></span>
                                                <input type="text" x-model="answers[q.number]"
                                                    :disabled="passageSubmitted[currentPassageIndex]"
                                                    @input="currentTestId && localStorage.setItem(`reading_answers_test${currentTestId}`, JSON.stringify(answers))"
                                                    :class="{
                                                            'correct': passageSubmitted[currentPassageIndex] && isCorrectFillItem(q.number, q.answer),
                                                            'incorrect': passageSubmitted[currentPassageIndex] && !isCorrectFillItem(q.number, q.answer) && answers[q.number]
                                                        }" class="fill-input w-36 px-3 py-2 rounded-lg text-white"
                                                    placeholder="...">
                                                <span class="text-white" x-text="q.textAfter || ''"></span>
                                                <span
                                                    x-show="passageSubmitted[currentPassageIndex] && !isCorrectFillItem(q.number, q.answer)"
                                                    class="text-green-400 text-sm" x-text="'(' + q.answer + ')'"></span>
                                            </div>
                                        </template>
                                    </div>
                                </div>
                            </template>

                            <!-- MATCHING HEADINGS (GT) -->
                            <template x-if="section.type === 'matchingHeadings'">
                                <div class="space-y-4">
                                    <div class="bg-white/5 rounded-xl p-4 border border-white/10 mb-4">
                                        <p class="text-white/70 font-semibold mb-2">List of Headings:</p>
                                        <template x-for="heading in section.headings" :key="heading.number">
                                            <p class="text-white/60 mb-1">
                                                <span class="text-gray-400 font-bold"
                                                    x-text="heading.number + '.'"></span>
                                                <span x-text="heading.text"></span>
                                            </p>
                                        </template>
                                    </div>
                                    <template x-for="q in section.items" :key="q.number">
                                        <div class="question-card rounded-xl p-4">
                                            <p class="text-white mb-3">
                                                <span class="text-gray-400 font-bold" x-text="q.number + '.'"></span>
                                                Section <span class="text-yellow-400 font-bold"
                                                    x-text="q.section"></span>
                                            </p>
                                            <div class="flex gap-2 flex-wrap">
                                                <template x-for="heading in section.headings" :key="heading.number">
                                                    <button
                                                        @click="!passageSubmitted[currentPassageIndex] && setAnswer(q.number, heading.number)"
                                                        :class="{
                                                                'selected': answers[q.number] === heading.number && !passageSubmitted[currentPassageIndex],
                                                                'correct': passageSubmitted[currentPassageIndex] && q.answer === heading.number,
                                                                'incorrect': passageSubmitted[currentPassageIndex] && answers[q.number] === heading.number && q.answer !== heading.number
                                                            }"
                                                        class="radio-option px-3 py-2 rounded-lg border border-white/20 text-sm font-medium transition-all"
                                                        :disabled="passageSubmitted[currentPassageIndex]">
                                                        <span x-text="heading.number"></span>
                                                    </button>
                                                </template>
                                            </div>
                                        </div>
                                    </template>
                                </div>
                            </template>

                            <!-- SECTION MATCHING (GT - A-G section matching) -->
                            <template x-if="section.type === 'sectionMatching'">
                                <div class="space-y-4">
                                    <template x-for="q in section.items" :key="q.number">
                                        <div class="question-card rounded-xl p-4">
                                            <p class="text-white mb-3">
                                                <span class="text-gray-400 font-bold" x-text="q.number + '.'"></span>
                                                <span x-text="q.statement || q.text"></span>
                                            </p>
                                            <div class="flex gap-2 flex-wrap">
                                                <template x-for="option in section.options" :key="option">
                                                    <button
                                                        @click="!passageSubmitted[currentPassageIndex] && setAnswer(q.number, option)"
                                                        :class="{
                                                        'selected': answers[q.number] === option && !passageSubmitted[currentPassageIndex],
                                                        'correct': passageSubmitted[currentPassageIndex] && q.answer === option,
                                                        'incorrect': passageSubmitted[currentPassageIndex] && answers[q.number] === option && q.answer !== option
                                                        }"
                                                        class="radio-option px-3 py-2 rounded-lg border border-white/20 text-sm font-medium transition-all"
                                                        :disabled="passageSubmitted[currentPassageIndex]">
                                                        <span x-text="option"></span>
                                                    </button>
                                                </template>
                                            </div>
                                        </div>
                                    </template>
                                </div>
                            </template>

                            <!-- SUMMARY COMPLETION (GT with blanks) -->
                            <template x-if="section.type === 'summaryCompletion'">
                                <div class="bg-white/5 rounded-xl p-4 border border-white/10">
                                    <h4 class="text-lg font-semibold text-white mb-4"
                                        x-text="section.summaryTitle || section.title"></h4>

                                    <!-- Summary paragraph with inline blanks -->
                                    <template x-if="section.summary">
                                        <p class="text-white/85 leading-relaxed mb-4"
                                            x-html="renderSummaryWithBlanks(section)"></p>
                                    </template>

                                    <!-- Answer inputs list with textBefore/textAfter -->
                                    <div class="space-y-3 mt-4"
                                        :class="{'border-t border-white/10 pt-4': section.summary}">
                                        <p x-show="section.summary" class="text-yellow-400 font-semibold text-sm mb-2">
                                            Your Answers:</p>
                                        <template x-for="q in section.items" :key="q.number">
                                            <div class="p-2 bg-white/5 rounded-lg">
                                                <div class="flex items-center gap-3 flex-wrap">
                                                    <span class="text-gray-400 font-bold w-8"
                                                        x-text="q.number + '.'"></span>
                                                    <span class="text-white" x-text="q.textBefore || ''"></span>
                                                    <input type="text" x-model="answers[q.number]"
                                                        :disabled="passageSubmitted[currentPassageIndex]"
                                                        @input="currentTestId && localStorage.setItem(`reading_answers_test${currentTestId}`, JSON.stringify(answers))"
                                                        :class="{
                                                                'correct': passageSubmitted[currentPassageIndex] && isCorrectFillItem(q.number, q.answer),
                                                                'incorrect': passageSubmitted[currentPassageIndex] && !isCorrectFillItem(q.number, q.answer) && answers[q.number]
                                                            }" class="fill-input w-36 px-3 py-2 rounded-lg text-white"
                                                        placeholder="...">
                                                    <span class="text-white" x-text="q.textAfter || ''"></span>
                                                    <span
                                                        x-show="passageSubmitted[currentPassageIndex] && !isCorrectFillItem(q.number, q.answer)"
                                                        class="text-green-400 text-sm" x-text="'(' + q.answer + ')'"></span>
                                                </div>
                                                <!-- Explanation -->
                                                <div x-show="passageSubmitted[currentPassageIndex] && q.explanation"
                                                    class="mt-2 p-2 bg-blue-500/10 border border-blue-500/30 rounded-lg">
                                                    <p class="text-blue-300 text-sm">
                                                        <span class="font-semibold">Explanation:</span>
                                                        <span x-text="q.explanation"></span>
                                                    </p>
                                                </div>
                                            </div>
                                        </template>
                                    </div>
                                </div>
                            </template>

                            <!-- TABLE COMPLETION (GT) -->
                            <template x-if="section.type === 'tableCompletion'">
                                <div class="bg-white/5 rounded-xl p-4 border border-white/10">
                                    <h4 class="text-lg font-semibold text-white mb-4" x-text="section.tableTitle"></h4>
                                    <div class="overflow-x-auto">
                                        <table class="w-full text-sm">
                                            <thead>
                                                <tr class="border-b border-white/20">
                                                    <template x-for="header in section.headers" :key="header">
                                                        <th class="text-left py-3 px-3 text-yellow-400 font-semibold"
                                                            x-text="header"></th>
                                                    </template>
                                                </tr>
                                            </thead>
                                            <tbody>
                                                <template x-for="(row, rowIndex) in section.rows" :key="rowIndex">
                                                    <tr class="border-b border-white/10">
                                                        <template x-for="(cell, cellIndex) in row.cells"
                                                            :key="cellIndex">
                                                            <td class="py-3 px-3 text-white/85 align-top">
                                                                <div
                                                                    x-html="renderTableCell(cell, row.answers, section)">
                                                                </div>
                                                            </td>
                                                        </template>
                                                    </tr>
                                                </template>
                                            </tbody>
                                        </table>
                                    </div>
                                </div>
                            </template>

                            <!-- HEADING MATCHING (GT - i-viii style) -->
                            <template x-if="section.type === 'headingMatching'">
                                <div class="space-y-4">
                                    <div class="bg-white/5 rounded-xl p-4 border border-white/10 mb-4">
                                        <p class="text-white/70 font-semibold mb-2">List of Headings:</p>
                                        <template x-for="heading in section.headings" :key="heading.number">
                                            <p class="text-white/60 mb-1">
                                                <span class="text-gray-400 font-bold"
                                                    x-text="heading.number + '.'"></span>
                                                <span x-text="heading.text"></span>
                                            </p>
                                        </template>
                                    </div>
                                    <template x-for="q in section.items" :key="q.number">
                                        <div class="question-card rounded-xl p-4">
                                            <p class="text-white mb-3">
                                                <span class="text-gray-400 font-bold" x-text="q.number + '.'"></span>
                                                <span x-text="q.statement"></span>
                                            </p>
                                            <div class="flex gap-2 flex-wrap">
                                                <template x-for="heading in section.headings" :key="heading.number">
                                                    <button
                                                        @click="!passageSubmitted[currentPassageIndex] && setAnswer(q.number, heading.number)"
                                                        :class="{
                                                            'selected': answers[q.number] === heading.number && !passageSubmitted[currentPassageIndex],
                                                            'correct': passageSubmitted[currentPassageIndex] && q.answer === heading.number,
                                                            'incorrect': passageSubmitted[currentPassageIndex] && answers[q.number] === heading.number && q.answer !== heading.number
                                                        }"
                                                        class="radio-option px-3 py-2 rounded-lg border border-white/20 text-sm font-medium transition-all"
                                                        :disabled="passageSubmitted[currentPassageIndex]">
                                                        <span x-text="heading.number"></span>
                                                    </button>
                                                </template>
                                            </div>
                                        </div>
                                    </template>
                                </div>
                            </template>

                        </div>
                    </template>

                    <!-- Submit / Results -->
                    <div class="glass-card rounded-2xl p-6">
                        <template x-if="!passageSubmitted[currentPassageIndex]">
                            <div class="flex flex-col gap-3">
                                <button @click="submitAnswers()"
                                    class="w-full bg-gradient-to-r from-gray-500 to-gray-500 hover:from-gray-600 hover:to-gray-600 text-white font-bold py-4 px-8 rounded-xl transition-all text-lg">
                                    Submit Answers ‚úì
                                </button>
                                <button @click="clearReadingAnswers()"
                                    class="w-full bg-red-500/20 hover:bg-red-500/30 text-red-400 font-medium py-2 px-6 rounded-xl transition-all text-sm">
                                    Clear Answers
                                </button>
                            </div>
                        </template>
                        <template x-if="passageSubmitted[currentPassageIndex]">
                            <div class="text-center">
                                <div class="text-4xl font-bold mb-2">
                                    <span class="text-green-400"
                                        x-text="passageScores[currentPassageIndex]?.score || 0"></span>
                                    <span class="text-white/50"
                                        x-text="'/ ' + (passageScores[currentPassageIndex]?.totalQuestions || 0)"></span>
                                </div>
                                <p class="text-white/50 mb-4">Correct Answers</p>
                                <div class="flex flex-col gap-2">
                                    <button @click="resetQuiz()"
                                        class="bg-white/10 hover:bg-white/20 text-white font-bold py-3 px-8 rounded-xl transition-all">
                                        Try Again üîÑ
                                    </button>
                                    <button @click="clearReadingAnswers()"
                                        class="bg-red-500/20 hover:bg-red-500/30 text-red-400 font-medium py-2 px-6 rounded-xl transition-all text-sm">
                                        Clear Answers
                                    </button>
                                </div>
                            </div>
                        </template>
                    </div>
                </div>
            </div>
        </div>
    </div>


    <!-- ==================== LISTENING SECTION VIEW ==================== -->
    <div x-show="currentView === 'listening'" class="h-screen flex flex-col overflow-hidden">

        <!-- Header -->
        <header class="glass-card flex-shrink-0 z-50">
            <div class="max-w-7xl mx-auto px-3 md:px-6 py-3 md:py-4 flex items-center justify-between">
                <button @click="window.location.href = 'ielts.html'"
                    class="flex items-center gap-2 text-white/60 hover:text-white transition-colors">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7" />
                    </svg>
                    <span class="hidden sm:inline">Testlere D√∂n</span>
                </button>

                <span class="text-white font-semibold text-sm md:text-base"
                    x-text="currentTestData?.name + ' - Listening'"></span>

                <div class="flex items-center gap-3">
                    <!-- Timer -->
                    <div class="flex items-center gap-2 bg-white/10 rounded-lg px-3 py-1.5">
                        <span class="text-white font-mono text-sm" x-text="formatTimer(listeningTimer)"></span>
                        <button @click="toggleListeningTimer()"
                            :class="listeningTimerRunning ? 'bg-yellow-500 hover:bg-yellow-600' : 'bg-green-500 hover:bg-green-600'"
                            class="text-white text-xs px-2 py-1 rounded transition-all">
                            <span x-text="listeningTimerRunning ? '‚è∏' : '‚ñ∂'"></span>
                        </button>
                        <button @click="resetListeningTimer()"
                            class="bg-red-500/50 hover:bg-red-500 text-white text-xs px-2 py-1 rounded transition-all">
                            ‚Ü∫
                        </button>
                    </div>
                    <div class="text-green-400 font-semibold">üéß <span class="hidden sm:inline">Listening</span></div>
                </div>
            </div>

            <!-- Mobile Panel Toggle -->
            <div class="md:hidden flex border-t border-white/10">
                <button @click="showVideoPanel = true"
                    :class="showVideoPanel ? 'bg-green-500/20 text-green-400 border-b-2 border-green-500' : 'text-white/60'"
                    class="flex-1 py-2 text-sm font-medium transition-all">
                    üé¨ Video
                </button>
                <button @click="showVideoPanel = false"
                    :class="!showVideoPanel ? 'bg-yellow-500/20 text-yellow-400 border-b-2 border-yellow-500' : 'text-white/60'"
                    class="flex-1 py-2 text-sm font-medium transition-all">
                    ‚ùì Questions
                </button>
            </div>
        </header>

        <!-- Content -->
        <div class="flex flex-1 min-h-0">

            <!-- Left Panel - Video (Narrower) -->
            <div class="w-full md:w-1/3 h-full overflow-y-auto border-r border-white/10"
                :class="{'hidden md:block': !showVideoPanel}">
                <div class="p-3">
                    <div class="glass-card rounded-xl p-3">
                        <h2 class="text-lg font-bold mb-2 text-green-400"
                            x-text="listeningData?.title || 'IELTS Listening'"></h2>

                        <!-- Audio Player for Google Drive (per part) -->
                        <div x-show="currentListeningPart?.audioUrl" class="w-full">
                            <div class="bg-white/5 rounded-lg p-4 border border-white/10">
                                <div class="flex items-center gap-3 mb-3">
                                    <span class="text-2xl">üéß</span>
                                    <span class="text-white/70 text-sm"
                                        x-text="currentListeningPart?.title + ' Audio'"></span>
                                </div>

                                <!-- Google Drive Audio Embed -->
                                <div class="rounded-lg overflow-hidden bg-black/30">
                                    <iframe :key="currentListeningPartIndex + '-' + Date.now()"
                                        :src="getGoogleDrivePreviewUrl(currentListeningPart?.audioUrl)"
                                        style="width: 100%; height: 120px; border: none;"
                                        allow="autoplay; encrypted-media"
                                        sandbox="allow-scripts allow-same-origin allow-popups"
                                        allowfullscreen>
                                    </iframe>
                                </div>

                                <p class="text-white/50 text-xs mt-2">Use the player controls above. Click play to start.</p>
                            </div>
                        </div>

                        <!-- Fallback: YouTube Video (if no audio) -->
                        <div x-show="listeningData?.videoUrl && !currentListeningPart?.audioUrl" class="relative w-full"
                            style="padding-bottom: 56.25%;">
                            <iframe :src="getYoutubeEmbedUrl(listeningData?.videoUrl)"
                                class="absolute top-0 left-0 w-full h-full rounded-lg" frameborder="0"
                                allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture"
                                allowfullscreen>
                            </iframe>
                        </div>

                        <!-- Transcript Toggle -->
                        <div class="mt-3">
                            <button @click="showTranscript = !showTranscript"
                                class="w-full p-2 bg-white/5 rounded-lg border border-white/10 hover:bg-white/10 transition-all flex items-center justify-between text-sm">
                                <span class="font-semibold text-yellow-400">üìú Transcript</span>
                                <span class="text-white/50 text-xs" x-text="showTranscript ? '‚ñ≤' : '‚ñº'"></span>
                            </button>
                            <div x-show="showTranscript"
                                class="mt-2 p-4 bg-white/5 rounded-lg border border-white/10 max-h-96 overflow-y-auto">
                                <template x-if="currentListeningPart?.transcript">
                                    <div class="text-white/90 text-base leading-relaxed whitespace-pre-line"
                                        x-text="currentListeningPart?.transcript">
                                    </div>
                                </template>
                                <template x-if="!currentListeningPart?.transcript">
                                    <p class="text-white/50 text-sm italic">No transcript available for this part.</p>
                                </template>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Right Panel - Questions (Wider) -->
            <div class="w-full md:w-2/3 h-full overflow-y-auto" :class="{'hidden md:block': showVideoPanel}">
                <div class="p-3 md:p-4 space-y-3 md:space-y-4">

                    <!-- Part Selector -->
                    <div class="glass-card rounded-xl p-2 sticky top-0 z-10">
                        <div class="flex gap-1.5 flex-wrap justify-center">
                            <template x-for="(part, index) in listeningData?.parts" :key="index">
                                <button @click="selectListeningPart(index)"
                                    :class="currentListeningPartIndex === index ? 'bg-green-500 text-white' : 'bg-white/10 hover:bg-white/20 text-white/70'"
                                    class="px-3 py-1.5 rounded-md font-semibold transition-all text-xs">
                                    <span x-text="part.title"></span>
                                </button>
                            </template>
                        </div>
                    </div>



                    <!-- Notes Type Questions -->
                    <template x-if="currentListeningPart?.type === 'notes'">
                        <div class="glass-card rounded-xl p-3">
                            <div class="bg-white/5 rounded-lg p-3 border border-white/10">
                                <h4 class="text-base font-semibold text-white mb-3"
                                    x-text="currentListeningPart?.noteTitle"></h4>
                                <div class="space-y-1.5">
                                    <template x-for="(item, itemIndex) in currentListeningPart?.items" :key="itemIndex">
                                        <div>
                                            <template x-if="item.isHeader">
                                                <p class="text-yellow-400 font-semibold text-sm mt-2 mb-1"
                                                    x-text="item.text">
                                                </p>
                                            </template>
                                            <template x-if="item.isSubHeader">
                                                <p class="text-yellow-300/80 font-medium text-sm mt-1 mb-0.5 ml-2"
                                                    x-text="item.text">
                                                </p>
                                            </template>
                                            <template x-if="!item.isHeader && !item.isSubHeader">
                                                <p class="text-white/85 text-sm flex items-center gap-1.5 flex-wrap">
                                                    <span>‚Ä¢</span>
                                                    <template x-for="(part, partIndex) in item.parts" :key="partIndex">
                                                        <span>
                                                            <template x-if="part.type === 'text'">
                                                                <span x-text="part.value"></span>
                                                            </template>
                                                            <template x-if="part.type === 'blank'">
                                                                <span class="inline-flex items-center gap-1">
                                                                    <span class="text-green-400 font-bold text-xs"
                                                                        x-text="part.number"></span>
                                                                    <input type="text"
                                                                        x-model="listeningAnswers[part.number]"
                                                                        @input="currentTestId && localStorage.setItem(`listening_answers_test${currentTestId}`, JSON.stringify(listeningAnswers))"
                                                                        :disabled="listeningPartSubmitted[currentListeningPartIndex]"
                                                                        :class="{
                                                                        'correct': listeningPartSubmitted[currentListeningPartIndex] && isCorrectListeningFill(part.number),
                                                                        'incorrect': listeningPartSubmitted[currentListeningPartIndex] && !isCorrectListeningFill(part.number) && listeningAnswers[part.number]
                                                                        }"
                                                                        class="fill-input w-28 px-2 py-0.5 rounded text-white text-center text-sm"
                                                                        placeholder="...">
                                                                    <span
                                                                        x-show="listeningPartSubmitted[currentListeningPartIndex] && !isCorrectListeningFill(part.number)"
                                                                        class="text-green-400 text-xs ml-1"
                                                                        x-text="'(' + currentListeningPart?.answers[part.number] + ')'"></span>
                                                                </span>
                                                            </template>
                                                        </span>
                                                    </template>
                                                </p>
                                            </template>
                                        </div>
                                    </template>
                                </div>
                            </div>

                            <!-- Table Section -->
                            <template x-if="currentListeningPart?.tableSection">
                                <div class="bg-white/5 rounded-lg p-3 border border-white/10 mt-3">
                                    <h4 class="text-base font-semibold text-white mb-2 text-center"
                                        x-text="currentListeningPart?.tableSection.title"></h4>
                                    <table class="w-full text-sm">
                                        <thead>
                                            <tr class="border-b border-white/20">
                                                <template x-for="header in currentListeningPart?.tableSection.headers"
                                                    :key="header">
                                                    <th class="text-left py-2 px-2 text-yellow-400 font-semibold text-xs"
                                                        x-text="header"></th>
                                                </template>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            <template x-for="(row, rowIndex) in currentListeningPart?.tableSection.rows"
                                                :key="rowIndex">
                                                <tr class="border-b border-white/10">
                                                    <!-- Column 1: Date/Time -->
                                                    <td class="py-2 px-2 text-white/70 text-sm" x-text="row.time"></td>

                                                    <!-- Column 2: Event/Activity -->
                                                    <td class="py-2 px-2 text-white/70 text-sm">
                                                        <template x-if="typeof row.activity === 'string'">
                                                            <span x-text="row.activity"></span>
                                                        </template>
                                                        <template x-if="Array.isArray(row.activity)">
                                                            <span>
                                                                <template x-for="(part, partIndex) in row.activity"
                                                                    :key="partIndex">
                                                                    <span>
                                                                        <template x-if="part.type === 'text'">
                                                                            <span x-text="part.value"></span>
                                                                        </template>
                                                                        <template x-if="part.type === 'blank'">
                                                                            <span
                                                                                class="inline-flex items-center gap-1">
                                                                                <span
                                                                                    class="text-green-400 font-bold text-xs"
                                                                                    x-text="part.number"></span>
                                                                                <input type="text"
                                                                                    x-model="listeningAnswers[part.number]"
                                                                                    @input="currentTestId && localStorage.setItem(`listening_answers_test${currentTestId}`, JSON.stringify(listeningAnswers))"
                                                                                    :disabled="listeningPartSubmitted[currentListeningPartIndex]"
                                                                                    :class="{
                                                                                    'correct': listeningPartSubmitted[currentListeningPartIndex] && isCorrectTableFill(part.number),
                                                                                    'incorrect': listeningPartSubmitted[currentListeningPartIndex] && !isCorrectTableFill(part.number) && listeningAnswers[part.number]
                                                                                    }"
                                                                                    class="fill-input w-24 px-2 py-0.5 rounded text-white text-center text-sm"
                                                                                    placeholder="...">
                                                                                <span
                                                                                    x-show="listeningPartSubmitted[currentListeningPartIndex] && !isCorrectTableFill(part.number)"
                                                                                    class="text-green-400 text-xs ml-1"
                                                                                    x-text="'(' + currentListeningPart?.tableSection.tableAnswers[part.number] + ')'"></span>
                                                                            </span>
                                                                        </template>
                                                                    </span>
                                                                </template>
                                                            </span>
                                                        </template>
                                                    </td>

                                                    <!-- Column 3: Location (if exists) -->
                                                    <template x-if="row.location !== undefined">
                                                        <td class="py-2 px-2 text-white/70 text-sm"
                                                            x-text="row.location"></td>
                                                    </template>

                                                    <!-- Column 3 or 4: Notes/Help needed -->
                                                    <td class="py-2 px-2 text-white/85 text-sm">
                                                        <template x-if="typeof row.notes === 'string'">
                                                            <span x-text="row.notes"></span>
                                                        </template>
                                                        <template x-if="Array.isArray(row.notes)">
                                                            <span>
                                                                <template x-for="(part, partIndex) in row.notes"
                                                                    :key="partIndex">
                                                                    <span>
                                                                        <template x-if="part.type === 'text'">
                                                                            <span x-text="part.value"></span>
                                                                        </template>
                                                                        <template x-if="part.type === 'blank'">
                                                                            <span
                                                                                class="inline-flex items-center gap-1">
                                                                                <span
                                                                                    class="text-green-400 font-bold text-xs"
                                                                                    x-text="part.number"></span>
                                                                                <input type="text"
                                                                                    x-model="listeningAnswers[part.number]"
                                                                                    @input="currentTestId && localStorage.setItem(`listening_answers_test${currentTestId}`, JSON.stringify(listeningAnswers))"
                                                                                    :disabled="listeningPartSubmitted[currentListeningPartIndex]"
                                                                                    :class="{
                                                                                    'correct': listeningPartSubmitted[currentListeningPartIndex] && isCorrectTableFill(part.number),
                                                                                    'incorrect': listeningPartSubmitted[currentListeningPartIndex] && !isCorrectTableFill(part.number) && listeningAnswers[part.number]
                                                                                    }"
                                                                                    class="fill-input w-24 px-2 py-0.5 rounded text-white text-center text-sm"
                                                                                    placeholder="...">
                                                                                <span
                                                                                    x-show="listeningPartSubmitted[currentListeningPartIndex] && !isCorrectTableFill(part.number)"
                                                                                    class="text-green-400 text-xs ml-1"
                                                                                    x-text="'(' + currentListeningPart?.tableSection.tableAnswers[part.number] + ')'"></span>
                                                                            </span>
                                                                        </template>
                                                                    </span>
                                                                </template>
                                                            </span>
                                                        </template>
                                                    </td>
                                                </tr>
                                            </template>
                                        </tbody>
                                    </table>
                                </div>
                            </template>

                            <!-- Explanations Section for Notes -->
                            <div x-show="listeningPartSubmitted[currentListeningPartIndex] && currentListeningPart?.explanations"
                                class="mt-4 space-y-2">
                                <h5 class="text-sm font-semibold text-blue-400 mb-2">Explanations:</h5>
                                <template x-for="(explanation, qNum) in currentListeningPart?.explanations" :key="qNum">
                                    <div class="p-2 bg-blue-500/10 border border-blue-500/30 rounded-lg">
                                        <p class="text-blue-300 text-xs">
                                            <span class="font-semibold text-green-400">Q<span x-text="qNum"></span>:</span>
                                            <span x-text="explanation"></span>
                                        </p>
                                    </div>
                                </template>
                            </div>
                        </div>
                    </template>

                    <!-- Multiple Choice / Complex Questions -->
                    <template
                        x-if="currentListeningPart?.type === 'multipleChoice' || currentListeningPart?.type === 'complex'">
                        <div class="glass-card rounded-xl p-3">
                            <div class="space-y-3">
                                <template x-for="(q, qIndex) in currentListeningPart?.items" :key="qIndex">
                                    <div>
                                        <!-- Regular MC -->
                                        <template x-if="!q.type">
                                            <div class="question-card rounded-lg p-3">
                                                <p class="text-white text-sm mb-2">
                                                    <span class="text-green-400 font-bold"
                                                        x-text="q.number + '.'"></span>
                                                    <span x-text="q.text"></span>
                                                </p>
                                                <div class="space-y-1.5">
                                                    <template x-for="option in q.options" :key="option.letter">
                                                        <button
                                                            @click="!listeningPartSubmitted[currentListeningPartIndex] && setListeningAnswer(q.number, option.letter)"
                                                            :class="{
                                                            'selected': listeningAnswers[q.number] === option.letter && !listeningPartSubmitted[currentListeningPartIndex],
                                                            'correct': listeningPartSubmitted[currentListeningPartIndex] && q.answer === option.letter,
                                                            'incorrect': listeningPartSubmitted[currentListeningPartIndex] && listeningAnswers[q.number] === option.letter && q.answer !== option.letter
                                                            }"
                                                            class="radio-option w-full text-left px-3 py-2 rounded-md border border-white/20 text-xs transition-all"
                                                            :disabled="listeningPartSubmitted[currentListeningPartIndex]">
                                                            <span class="font-bold mr-1" x-text="option.letter"></span>
                                                            <span x-text="option.text"></span>
                                                        </button>
                                                    </template>
                                                </div>
                                            </div>
                                        </template>

                                        <!-- Choose Two Group -->
                                        <template x-if="q.type === 'chooseTwoGroup'">
                                            <div class="question-card rounded-xl p-4 mb-4">
                                                <div class="mb-4">
                                                    <p class="text-green-400 font-bold text-lg mb-2">
                                                        Questions <span x-text="q.questionNumbers.join(' and ')"></span>
                                                    </p>
                                                    <p class="text-white/70 text-sm mb-3">Choose TWO letters, A-E.</p>
                                                    <p class="text-white mb-4" x-text="q.text"></p>
                                                </div>
                                                <div class="space-y-2">
                                                    <template x-for="option in q.options" :key="option.letter">
                                                        <button
                                                            @click="!listeningPartSubmitted[currentListeningPartIndex] && toggleChooseTwoAnswer(q.questionNumbers, option.letter)"
                                                            :class="{
                                                            'selected': isChooseTwoSelected(q.questionNumbers, option.letter) && !listeningPartSubmitted[currentListeningPartIndex],
                                                            'correct': listeningPartSubmitted[currentListeningPartIndex] && q.answers.includes(option.letter),
                                                            'incorrect': listeningPartSubmitted[currentListeningPartIndex] && isChooseTwoSelected(q.questionNumbers, option.letter) && !q.answers.includes(option.letter)
                                                            }"
                                                            class="radio-option w-full text-left px-4 py-3 rounded-lg border border-white/20 text-sm transition-all flex items-center gap-3"
                                                            :disabled="listeningPartSubmitted[currentListeningPartIndex]">
                                                            <span
                                                                class="w-6 h-6 rounded border-2 flex items-center justify-center text-xs"
                                                                :class="isChooseTwoSelected(q.questionNumbers, option.letter) ? 'bg-green-500 border-green-500' : 'border-white/40'">
                                                                <span
                                                                    x-show="isChooseTwoSelected(q.questionNumbers, option.letter)">‚úì</span>
                                                            </span>
                                                            <span class="font-bold" x-text="option.letter + '.'"></span>
                                                            <span x-text="option.text"></span>
                                                        </button>
                                                    </template>
                                                </div>
                                            </div>
                                        </template>

                                        <!-- Matching Group -->
                                        <template x-if="q.type === 'matchingGroup'">
                                            <div class="question-card rounded-xl p-4 mb-4">
                                                <div class="mb-4">
                                                    <p class="text-green-400 font-bold text-lg mb-2" x-text="q.title">
                                                    </p>
                                                    <p class="text-white mb-2" x-text="q.text"></p>
                                                    <p class="text-white/50 text-sm" x-text="q.instructions"></p>
                                                </div>
                                                <div class="bg-white/5 rounded-xl p-4 border border-white/10 mb-4">
                                                    <p class="text-yellow-400 font-semibold mb-3">Options:</p>
                                                    <div class="flex flex-wrap gap-2">
                                                        <template x-for="option in q.options" :key="option.letter">
                                                            <div class="bg-white/10 px-3 py-2 rounded-lg text-sm">
                                                                <span class="text-green-400 font-bold"
                                                                    x-text="option.letter + '.'"></span>
                                                                <span class="text-white/70" x-text="option.text"></span>
                                                            </div>
                                                        </template>
                                                    </div>
                                                </div>
                                                <div class="space-y-3">
                                                    <template x-for="item in q.items" :key="item.number">
                                                        <div class="flex items-center gap-4 p-3 bg-white/5 rounded-lg">
                                                            <span class="text-green-400 font-bold w-8"
                                                                x-text="item.number"></span>
                                                            <span class="text-white flex-1" x-text="item.label"></span>
                                                            <select x-model="listeningAnswers[item.number]"
                                                                @change="currentTestId && localStorage.setItem(`listening_answers_test${currentTestId}`, JSON.stringify(listeningAnswers))"
                                                                :disabled="listeningPartSubmitted[currentListeningPartIndex]"
                                                                :class="{
                                                                'correct': listeningPartSubmitted[currentListeningPartIndex] && listeningAnswers[item.number] === q.answers[item.number],
                                                                'incorrect': listeningPartSubmitted[currentListeningPartIndex] && listeningAnswers[item.number] && listeningAnswers[item.number] !== q.answers[item.number]
                                                                }"
                                                                class="fill-input px-4 py-2 rounded-lg text-white w-20 text-center">
                                                                <option value="" class="bg-gray-800">-</option>
                                                                <template x-for="option in q.options"
                                                                    :key="option.letter">
                                                                    <option :value="option.letter"
                                                                        x-text="option.letter" class="bg-gray-800">
                                                                    </option>
                                                                </template>
                                                            </select>
                                                            <span
                                                                x-show="listeningPartSubmitted[currentListeningPartIndex] && listeningAnswers[item.number] !== q.answers[item.number]"
                                                                class="text-green-400 text-sm"
                                                                x-text="'(' + q.answers[item.number] + ')'"></span>
                                                        </div>
                                                    </template>
                                                </div>
                                            </div>
                                        </template>

                                        <!-- Flowchart -->
                                        <template x-if="q.type === 'flowchart'">
                                            <div class="question-card rounded-xl p-4 mb-4">
                                                <div class="mb-4">
                                                    <p class="text-green-400 font-bold text-lg mb-2" x-text="q.title">
                                                    </p>
                                                    <p class="text-white/50 text-sm" x-text="q.instructions"></p>
                                                </div>
                                                <div class="bg-white/5 rounded-xl p-4 border border-white/10 mb-4">
                                                    <p class="text-yellow-400 font-semibold mb-3">Options:</p>
                                                    <div class="flex flex-wrap gap-2">
                                                        <template x-for="option in q.options" :key="option.letter">
                                                            <div class="bg-white/10 px-3 py-2 rounded-lg text-sm">
                                                                <span class="text-green-400 font-bold"
                                                                    x-text="option.letter + '.'"></span>
                                                                <span class="text-white/70" x-text="option.text"></span>
                                                            </div>
                                                        </template>
                                                    </div>
                                                </div>
                                                <div class="space-y-3">
                                                    <template x-for="item in q.items" :key="item.number">
                                                        <div class="flex items-center gap-4 p-3 bg-white/5 rounded-lg">
                                                            <span class="text-green-400 font-bold w-8"
                                                                x-text="item.number"></span>
                                                            <span class="text-white flex-1" x-text="item.text"></span>
                                                            <select x-model="listeningAnswers[item.number]"
                                                                :disabled="listeningPartSubmitted[currentListeningPartIndex]"
                                                                :class="{
                                                                'correct': listeningPartSubmitted[currentListeningPartIndex] && listeningAnswers[item.number] === q.answers[item.number],
                                                                'incorrect': listeningPartSubmitted[currentListeningPartIndex] && listeningAnswers[item.number] && listeningAnswers[item.number] !== q.answers[item.number]
                                                                    }"
                                                                class="fill-input px-4 py-2 rounded-lg text-white w-20 text-center">
                                                                <option value="" class="bg-gray-800">-</option>
                                                                <template x-for="option in q.options"
                                                                    :key="option.letter">
                                                                    <option :value="option.letter"
                                                                        x-text="option.letter" class="bg-gray-800">
                                                                    </option>
                                                                </template>
                                                            </select>
                                                            <span
                                                                x-show="listeningPartSubmitted[currentListeningPartIndex] && listeningAnswers[item.number] !== q.answers[item.number]"
                                                                class="text-green-400 text-sm"
                                                                x-text="'(' + q.answers[item.number] + ')'"></span>
                                                        </div>
                                                    </template>
                                                </div>
                                            </div>
                                        </template>

                                        <!-- Map Labeling -->
                                        <template x-if="q.type === 'mapLabeling'">
                                            <div class="question-card rounded-xl p-4 mb-4">
                                                <div class="mb-4">
                                                    <p class="text-green-400 font-bold text-lg mb-2" x-text="q.title">
                                                    </p>
                                                    <p class="text-white/50 text-sm" x-text="q.instructions"></p>
                                                </div>
                                                <!-- Map Image -->
                                                <template x-if="q.mapImage">
                                                    <div class="mb-4">
                                                        <p class="text-yellow-400 font-semibold mb-2"
                                                            x-text="q.mapTitle"></p>
                                                        <img :src="q.mapImage" :alt="q.mapTitle"
                                                            class="w-full max-w-2xl mx-auto rounded-lg border border-white/20">
                                                    </div>
                                                </template>
                                                <!-- Questions -->
                                                <div class="space-y-3">
                                                    <template x-for="item in q.items" :key="item.number">
                                                        <div class="flex items-center gap-4 p-3 bg-white/5 rounded-lg">
                                                            <span class="text-green-400 font-bold w-8"
                                                                x-text="item.number"></span>
                                                            <span class="text-white flex-1" x-text="item.label"></span>
                                                            <select x-model="listeningAnswers[item.number]"
                                                                @change="currentTestId && localStorage.setItem(`listening_answers_test${currentTestId}`, JSON.stringify(listeningAnswers))"
                                                                :disabled="listeningPartSubmitted[currentListeningPartIndex]"
                                                                :class="{
                                                                'correct': listeningPartSubmitted[currentListeningPartIndex] && listeningAnswers[item.number] === item.answer,
                                                                'incorrect': listeningPartSubmitted[currentListeningPartIndex] && listeningAnswers[item.number] && listeningAnswers[item.number] !== item.answer
                                                                    }"
                                                                class="fill-input px-4 py-2 rounded-lg text-white w-20 text-center">
                                                                <option value="" class="bg-gray-800">-</option>
                                                                <template x-for="option in q.options" :key="option">
                                                                    <option :value="option" x-text="option"
                                                                        class="bg-gray-800">
                                                                    </option>
                                                                </template>
                                                            </select>
                                                            <span
                                                                x-show="listeningPartSubmitted[currentListeningPartIndex] && listeningAnswers[item.number] !== item.answer"
                                                                class="text-green-400 text-sm"
                                                                x-text="'(' + item.answer + ')'"></span>
                                                        </div>
                                                    </template>
                                                </div>
                                            </div>
                                        </template>

                                        <!-- Notes Group (fill in blanks within complex type) -->
                                        <template x-if="q.type === 'notesGroup'">
                                            <div class="question-card rounded-xl p-4 mb-4">
                                                <div class="mb-4">
                                                    <p class="text-green-400 font-bold text-lg mb-2" x-text="q.title">
                                                    </p>
                                                    <p class="text-white/50 text-sm" x-text="q.instructions"></p>
                                                </div>
                                                <div class="bg-white/5 rounded-lg p-3 border border-white/10">
                                                    <h4 class="text-base font-semibold text-white mb-3"
                                                        x-text="q.noteTitle"></h4>
                                                    <div class="space-y-1.5">
                                                        <template x-for="(item, itemIndex) in q.items" :key="itemIndex">
                                                            <div>
                                                                <template x-if="item.isHeader">
                                                                    <p class="text-yellow-400 font-semibold text-sm mt-2 mb-1"
                                                                        x-text="item.text"></p>
                                                                </template>
                                                                <template x-if="item.isSubHeader">
                                                                    <p class="text-yellow-300/80 font-medium text-sm mt-1 mb-0.5 ml-2"
                                                                        x-text="item.text"></p>
                                                                </template>
                                                                <template x-if="!item.isHeader && !item.isSubHeader">
                                                                    <p
                                                                        class="text-white/85 text-sm flex items-center gap-1.5 flex-wrap">
                                                                        <span>‚Ä¢</span>
                                                                        <template
                                                                            x-for="(part, partIndex) in item.parts"
                                                                            :key="partIndex">
                                                                            <span>
                                                                                <template x-if="part.type === 'text'">
                                                                                    <span x-text="part.value"></span>
                                                                                </template>
                                                                                <template x-if="part.type === 'blank'">
                                                                                    <span
                                                                                        class="inline-flex items-center gap-1">
                                                                                        <span
                                                                                            class="text-green-400 font-bold text-xs"
                                                                                            x-text="part.number"></span>
                                                                                        <input type="text"
                                                                                            x-model="listeningAnswers[part.number]"
                                                                                            @input="currentTestId && localStorage.setItem(`listening_answers_test${currentTestId}`, JSON.stringify(listeningAnswers))"
                                                                                            :disabled="listeningPartSubmitted[currentListeningPartIndex]"
                                                                                            :class="{
                                                                                                'correct': listeningPartSubmitted[currentListeningPartIndex] && isCorrectNotesGroupFill(q, part.number),
                                                                                                'incorrect': listeningPartSubmitted[currentListeningPartIndex] && !isCorrectNotesGroupFill(q, part.number) && listeningAnswers[part.number]
                                                                                            }"
                                                                                            class="fill-input w-28 px-2 py-0.5 rounded text-white text-center text-sm"
                                                                                            placeholder="...">
                                                                                        <span
                                                                                            x-show="listeningPartSubmitted[currentListeningPartIndex] && !isCorrectNotesGroupFill(q, part.number)"
                                                                                            class="text-green-400 text-xs ml-1"
                                                                                            x-text="'(' + q.answers[part.number] + ')'"></span>
                                                                                    </span>
                                                                                </template>
                                                                            </span>
                                                                        </template>
                                                                    </p>
                                                                </template>
                                                            </div>
                                                        </template>
                                                    </div>
                                                </div>
                                            </div>
                                        </template>

                                        <!-- Regular Multiple Choice (for complex type) -->
                                        <template x-if="q.type === 'multipleChoice'">
                                            <div class="question-card rounded-xl p-4 mb-4">
                                                <div class="mb-4">
                                                    <p class="text-green-400 font-bold text-lg mb-2" x-text="q.title">
                                                    </p>
                                                    <p class="text-white/50 text-sm" x-text="q.instructions"></p>
                                                </div>
                                                <div class="space-y-6">
                                                    <template x-for="mcItem in q.items" :key="mcItem.number">
                                                        <div class="bg-white/5 rounded-xl p-4">
                                                            <p class="text-white mb-4">
                                                                <span class="text-green-400 font-bold"
                                                                    x-text="mcItem.number + '.'"></span>
                                                                <span x-text="mcItem.text"></span>
                                                            </p>
                                                            <div class="space-y-2">
                                                                <template x-for="option in mcItem.options"
                                                                    :key="option.letter">
                                                                    <button
                                                                        @click="!listeningPartSubmitted[currentListeningPartIndex] && setListeningAnswer(mcItem.number, option.letter)"
                                                                        :class="{
                                                                                'selected': listeningAnswers[mcItem.number] === option.letter && !listeningPartSubmitted[currentListeningPartIndex],
                                                                                'correct': listeningPartSubmitted[currentListeningPartIndex] && mcItem.answer === option.letter,
                                                                                'incorrect': listeningPartSubmitted[currentListeningPartIndex] && listeningAnswers[mcItem.number] === option.letter && mcItem.answer !== option.letter
                                                                            }"
                                                                        class="radio-option w-full text-left px-4 py-3 rounded-lg border border-white/20 text-sm transition-all"
                                                                        :disabled="listeningPartSubmitted[currentListeningPartIndex]">
                                                                        <span class="font-bold mr-2"
                                                                            x-text="option.letter"></span>
                                                                        <span x-text="option.text"></span>
                                                                    </button>
                                                                </template>
                                                            </div>
                                                        </div>
                                                    </template>
                                                </div>
                                            </div>
                                        </template>
                                    </div>
                                </template>
                            </div>

                            <!-- Explanations Section for Multiple Choice / Complex -->
                            <div x-show="listeningPartSubmitted[currentListeningPartIndex] && currentListeningPart?.explanations"
                                class="mt-4 space-y-2">
                                <h5 class="text-sm font-semibold text-blue-400 mb-2">Explanations:</h5>
                                <template x-for="(explanation, qNum) in currentListeningPart?.explanations" :key="qNum">
                                    <div class="p-2 bg-blue-500/10 border border-blue-500/30 rounded-lg">
                                        <p class="text-blue-300 text-xs">
                                            <span class="font-semibold text-green-400">Q<span x-text="qNum"></span>:</span>
                                            <span x-text="explanation"></span>
                                        </p>
                                    </div>
                                </template>
                            </div>
                        </div>
                    </template>

                    <!-- Submit / Results -->
                    <div class="glass-card rounded-2xl p-6">
                        <template x-if="!listeningPartSubmitted[currentListeningPartIndex]">
                            <div class="flex flex-col gap-3">
                                <button @click="submitListeningAnswers()"
                                    class="w-full bg-gradient-to-r from-green-500 to-teal-500 hover:from-green-600 hover:to-teal-600 text-white font-bold py-4 px-8 rounded-xl transition-all text-lg">
                                    Submit Answers ‚úì
                                </button>
                                <button @click="clearListeningAnswers()"
                                    class="w-full bg-red-500/20 hover:bg-red-500/30 text-red-400 font-medium py-2 px-6 rounded-xl transition-all text-sm">
                                    Clear Answers
                                </button>
                            </div>
                        </template>
                        <template x-if="listeningPartSubmitted[currentListeningPartIndex]">
                            <div class="text-center">
                                <div class="text-4xl font-bold mb-2">
                                    <span class="text-green-400"
                                        x-text="listeningPartScores[currentListeningPartIndex]?.score || 0"></span>
                                    <span class="text-white/50"
                                        x-text="'/ ' + (listeningPartScores[currentListeningPartIndex]?.totalQuestions || 0)"></span>
                                </div>
                                <p class="text-white/50 mb-4">Correct Answers</p>
                                <div class="flex flex-col gap-2">
                                    <button @click="resetListeningQuiz()"
                                        class="bg-white/10 hover:bg-white/20 text-white font-bold py-3 px-8 rounded-xl transition-all">
                                        Try Again üîÑ
                                    </button>
                                    <button @click="clearListeningAnswers()"
                                        class="bg-red-500/20 hover:bg-red-500/30 text-red-400 font-medium py-2 px-6 rounded-xl transition-all text-sm">
                                        Clear Answers
                                    </button>
                                </div>
                            </div>
                        </template>
                    </div>
                </div>
            </div>
        </div>
    </div>


    <!-- ==================== WRITING SECTION VIEW ==================== -->
    <div x-show="currentView === 'writing'" class="min-h-screen flex flex-col">
        <header class="glass-card sticky top-0 z-50">
            <div class="max-w-7xl mx-auto px-6 py-4 flex items-center justify-between">
                <button @click="window.location.href = 'ielts.html'"
                    class="flex items-center gap-2 text-white/60 hover:text-white transition-colors">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7" />
                    </svg>
                    <span>Testlere D√∂n</span>
                </button>
                <span class="text-white font-semibold" x-text="currentTestData?.name + ' - Writing'"></span>
                <div class="text-blue-400 font-semibold">‚úçÔ∏è Writing</div>
            </div>
        </header>

        <div class="flex-1 flex items-center justify-center p-6">
            <div class="text-center max-w-lg">
                <div class="text-8xl mb-8">‚úçÔ∏è</div>
                <h2 class="text-3xl font-bold text-white mb-4">Writing Section</h2>
                <p class="text-white/50 text-lg mb-8">Coming soon! Practice your IELTS Writing tasks here.</p>
                <div class="glass-card rounded-2xl p-6">
                    <div class="space-y-3 text-left">
                        <div class="flex items-center gap-3 text-blue-300">
                            <span class="text-2xl">üìä</span>
                            <span>Task 1: Graph/Chart description (20 min)</span>
                        </div>
                        <div class="flex items-center gap-3 text-blue-300">
                            <span class="text-2xl">üìù</span>
                            <span>Task 2: Essay writing (40 min)</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>


    <!-- ==================== SPEAKING SECTION VIEW ==================== -->
    <div x-show="currentView === 'speaking'" class="min-h-screen flex flex-col">
        <header class="glass-card sticky top-0 z-50">
            <div class="max-w-7xl mx-auto px-6 py-4 flex items-center justify-between">
                <button @click="window.location.href = 'ielts.html'"
                    class="flex items-center gap-2 text-white/60 hover:text-white transition-colors">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7" />
                    </svg>
                    <span>Testlere D√∂n</span>
                </button>
                <span class="text-white font-semibold" x-text="currentTestData?.name + ' - Speaking'"></span>
                <div class="text-orange-400 font-semibold">üó£Ô∏è Speaking</div>
            </div>
        </header>

        <div class="flex-1 flex items-center justify-center p-6">
            <div class="text-center max-w-lg">
                <div class="text-8xl mb-8">üó£Ô∏è</div>
                <h2 class="text-3xl font-bold text-white mb-4">Speaking Section</h2>
                <p class="text-white/50 text-lg mb-8">Coming soon! Practice your IELTS Speaking skills here.</p>
                <div class="glass-card rounded-2xl p-6">
                    <div class="space-y-3 text-left">
                        <div class="flex items-center gap-3 text-orange-300">
                            <span class="text-2xl">üé§</span>
                            <span>Part 1: Introduction & Interview (4-5 min)</span>
                        </div>
                        <div class="flex items-center gap-3 text-orange-300">
                            <span class="text-2xl">üéØ</span>
                            <span>Part 2: Long Turn - Cue Card (3-4 min)</span>
                        </div>
                        <div class="flex items-center gap-3 text-orange-300">
                            <span class="text-2xl">üí¨</span>
                            <span>Part 3: Discussion (4-5 min)</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>


    <script>
        function ieltsApp() {
            return {
                currentView: null, // null initially, then: list, reading, listening, writing, speaking
                selectedCategory: 'academic', // academic, general
                selectedTestId: null,
                currentPassageIndex: 0,
                currentSectionIndex: 0, // for General Training sections
                currentPassage: null,
                currentPassages: [],
                currentSections: [], // for General Training
                answers: {},
                passageSubmitted: {}, // per-passage passageSubmitted[currentPassageIndex] state: { passageIndex: true/false }
                passageScores: {}, // per-passage scores: { passageIndex: { score, totalQuestions } }
                currentTestData: null,
                showPassagePanel: true, // for mobile toggle
                showVideoPanel: true, // for mobile listening toggle
                showTranscript: false, // for transcript toggle

                // Listening state
                listeningData: null,
                currentListeningPartIndex: 0,
                currentListeningPart: null,
                currentTestId: null, // for localStorage tracking
                listeningAnswers: {},
                listeningPartSubmitted: {}, // per-part passageSubmitted[currentPassageIndex] state: { partIndex: true/false }
                listeningPartScores: {}, // per-part scores: { partIndex: { score, totalQuestions } }

                // Timer state
                readingTimer: 0,
                readingTimerRunning: false,
                readingTimerInterval: null,
                listeningTimer: 0,
                listeningTimerRunning: false,
                listeningTimerInterval: null,

                // Cache for loaded test data (lazy loading)
                testDataCache: {},

                // Academic Tests (auto-discovered)
                academicTests: [],

                // General Training Tests (auto-discovered)
                generalTests: [],

                // Auto-discover tests on init
                async init() {
                    // Check URL parameters first (before showing anything)
                    const urlParams = new URLSearchParams(window.location.search);
                    const testId = parseInt(urlParams.get('test'));
                    const section = urlParams.get('section');

                    await this.discoverTests();

                    if (testId && section) {
                        // Open the test directly
                        this.openSection(testId, section);
                    } else {
                        // No URL params, show list view
                        this.currentView = 'list';
                    }
                },

                discoverTests() {
                    // Hardcoded test list for instant loading (no HTTP requests)
                    this.generalTests = [
                        { id: 1, name: 'Cambridge 17 Test 4', file: 'ielts-tests/general/general-test-17-4.json', listeningFile: 'ielts-tests/listening/test-17-4.json', type: 'general' },
                        { id: 2, name: 'Cambridge 16 Test 1', file: 'ielts-tests/general/general-test-16-1.json', listeningFile: 'ielts-tests/listening/test-16-1.json', type: 'general' },
                        { id: 3, name: 'Cambridge 16 Test 2', file: 'ielts-tests/general/general-test-16-2.json', listeningFile: 'ielts-tests/listening/test-16-2.json', type: 'general' },
                        { id: 4, name: 'Cambridge 16 Test 3', file: 'ielts-tests/general/general-test-16-3.json', listeningFile: 'ielts-tests/listening/test-16-3.json', type: 'general' },
                        { id: 5, name: 'Cambridge 16 Test 4', file: 'ielts-tests/general/general-test-16-4.json', listeningFile: 'ielts-tests/listening/test-16-4.json', type: 'general' }
                    ];
                },

                get currentTests() {
                    return this.selectedCategory === 'academic' ? this.academicTests : this.generalTests;
                },

                get testSets() {
                    return [...this.academicTests, ...this.generalTests];
                },

                async openSection(testId, section) {
                    this.selectedTestId = testId;
                    const testConfig = this.generalTests.find(t => t.id === testId);
                    this.currentTestData = testConfig;

                    if (testConfig) {
                        try {
                            if (section === 'reading' && testConfig.file) {
                                // Lazy loading with cache
                                let testData;
                                const cacheKey = `reading_${testConfig.id}`;
                                if (this.testDataCache[cacheKey]) {
                                    testData = this.testDataCache[cacheKey];
                                } else {
                                    const response = await fetch(testConfig.file);
                                    testData = await response.json();
                                    this.testDataCache[cacheKey] = testData;
                                }

                                if (testData.reading) {
                                    this.currentTestId = testConfig.id; // for localStorage
                                    // Check if it's General Training format (has sections)
                                    if (testData.reading.sections) {
                                        this.currentSections = testData.reading.sections;
                                        this.currentSectionIndex = 0;
                                        // Flatten passages from sections for GT
                                        this.currentPassages = [];
                                        testData.reading.sections.forEach((sec, secIdx) => {
                                            sec.passages.forEach((passage, passIdx) => {
                                                this.currentPassages.push({
                                                    ...passage,
                                                    sectionNumber: secIdx + 1,
                                                    sectionTitle: sec.title,
                                                    questionRange: sec.questionRange
                                                });
                                            });
                                        });
                                    } else {
                                        // Academic format (passages directly)
                                        this.currentPassages = testData.reading.passages;
                                    }
                                    // Load saved answers from localStorage
                                    const savedReadingAnswers = localStorage.getItem(`reading_answers_test${testConfig.id}`);
                                    if (savedReadingAnswers) {
                                        this.answers = JSON.parse(savedReadingAnswers);
                                    } else {
                                        this.answers = {};
                                    }
                                    // Load per-passage passageSubmitted[currentPassageIndex] states from localStorage
                                    const savedPassageSubmitted = localStorage.getItem(`reading_passage_passageSubmitted[currentPassageIndex]_test${testConfig.id}`);
                                    if (savedPassageSubmitted) {
                                        this.passageSubmitted = JSON.parse(savedPassageSubmitted);
                                    } else {
                                        this.passageSubmitted = {};
                                    }
                                    // Load per-passage scores from localStorage
                                    const savedPassageScores = localStorage.getItem(`reading_passage_scores_test${testConfig.id}`);
                                    if (savedPassageScores) {
                                        this.passageScores = JSON.parse(savedPassageScores);
                                    } else {
                                        this.passageScores = {};
                                    }

                                    this.currentPassageIndex = 0;
                                    this.loadPassage();
                                }
                            }

                            if (section === 'listening') {
                                // Lazy loading with cache
                                let testData;
                                const cacheKey = `listening_${testConfig.id}`;
                                if (this.testDataCache[cacheKey]) {
                                    testData = this.testDataCache[cacheKey];
                                } else {
                                    const response = await fetch(testConfig.listeningFile);
                                    testData = await response.json();
                                    this.testDataCache[cacheKey] = testData;
                                }

                                if (testData.listening) {
                                    this.listeningData = testData.listening;
                                    this.currentTestId = testConfig.id; // for localStorage
                                    this.currentListeningPartIndex = 0;
                                    // Load saved answers from localStorage
                                    const savedAnswers = localStorage.getItem(`listening_answers_test${testConfig.id}`);
                                    if (savedAnswers) {
                                        this.listeningAnswers = JSON.parse(savedAnswers);
                                    } else {
                                        this.listeningAnswers = {};
                                    }
                                    // Load per-part submitted states from localStorage
                                    const savedPartSubmitted = localStorage.getItem(`listening_part_submitted_test${testConfig.id}`);
                                    if (savedPartSubmitted) {
                                        this.listeningPartSubmitted = JSON.parse(savedPartSubmitted);
                                    } else {
                                        this.listeningPartSubmitted = {};
                                    }
                                    // Load per-part scores from localStorage
                                    const savedPartScores = localStorage.getItem(`listening_part_scores_test${testConfig.id}`);
                                    if (savedPartScores) {
                                        this.listeningPartScores = JSON.parse(savedPartScores);
                                    } else {
                                        this.listeningPartScores = {};
                                    }

                                    this.loadListeningPart();
                                }
                            }
                        } catch (error) {
                            console.error('Error loading test:', error);
                        }
                    }

                    this.currentView = section;
                },

                // Reading functions
                loadPassage() {
                    this.currentPassage = this.currentPassages[this.currentPassageIndex];
                    // Don't reset submitted state - it persists from localStorage
                },

                setAnswer(number, value) {
                    this.answers[number] = value;
                    // Save to localStorage
                    if (this.currentTestId) {
                        localStorage.setItem(`reading_answers_test${this.currentTestId}`, JSON.stringify(this.answers));
                    }
                },

                isCorrectFill(section, number) {
                    if (!section.answers) return false;
                    const userAnswer = (this.answers[number] || '').toLowerCase().trim();
                    const correctAnswer = (section.answers[number] || '').toLowerCase().trim();
                    return userAnswer === correctAnswer;
                },

                isCorrectFillItem(number, correctAnswer) {
                    const userAnswer = (this.answers[number] || '').toLowerCase().trim();
                    const correct = (correctAnswer || '').toLowerCase().trim();
                    return userAnswer === correct;
                },

                renderSummaryWithBlanks(section) {
                    if (!section.summary) return '';
                    let html = section.summary;
                    // Replace {number} placeholders with underlined numbers
                    section.items.forEach(item => {
                        const placeholder = '{' + item.number + '}';
                        const replacement = `<span class="text-gray-400 border-b-2 border-gray-400 px-2">${item.number}</span>`;
                        html = html.replace(placeholder, replacement);
                    });
                    return html;
                },

                renderTableCell(cell, rowAnswers, section) {
                    if (!cell) return '';
                    // Replace newlines with <br> tags
                    let html = cell.replace(/\n/g, '<br>');
                    // Find all question numbers (e.g., "15 ___" or just "___") and replace with inputs
                    if (rowAnswers) {
                        Object.keys(rowAnswers).forEach(num => {
                            // Pattern matches "NUMBER ___" or just the number followed by ___
                            const pattern = new RegExp(`${num}\\s*___`, 'g');
                            const userAnswer = this.answers[num] || '';
                            const correctAnswer = rowAnswers[num] || '';
                            const isSubmitted = this.passageSubmitted[this.currentPassageIndex];
                            const isCorrect = userAnswer.toLowerCase().trim() === correctAnswer.toLowerCase().trim();

                            let inputClass = 'fill-input w-28 px-2 py-1 rounded text-white text-center text-sm';
                            if (isSubmitted && userAnswer) {
                                inputClass += isCorrect ? ' correct' : ' incorrect';
                            }

                            const correctShow = isSubmitted && !isCorrect ?
                                `<span class="text-green-400 text-xs ml-1">(${correctAnswer})</span>` : '';

                            const inputHtml = `<span class="inline-flex items-center gap-1">
                                <span class="text-gray-400 font-bold text-xs">${num}</span>
                                <input type="text"
                                    x-model="answers[${num}]"
                                    @input="currentTestId && localStorage.setItem('reading_answers_test' + currentTestId, JSON.stringify(answers))"
                                    ${isSubmitted ? 'disabled' : ''}
                                    class="${inputClass}"
                                    placeholder="...">
                                ${correctShow}
                            </span>`;

                            html = html.replace(pattern, inputHtml);
                        });
                    }
                    return html;
                },

                isCorrectTableFill(section, number) {
                    // Find the answer in section.rows
                    for (const row of (section.rows || [])) {
                        if (row.answers && row.answers[number] !== undefined) {
                            const userAnswer = (this.answers[number] || '').toLowerCase().trim();
                            const correctAnswer = (row.answers[number] || '').toLowerCase().trim();
                            return userAnswer === correctAnswer;
                        }
                    }
                    return false;
                },

                submitAnswers() {
                    const passageIndex = this.currentPassageIndex;
                    let score = 0;
                    let totalQuestions = 0;

                    this.currentPassage?.questions.forEach(section => {
                        // Multiple choice style questions (select from options)
                        if (['tfng', 'matching', 'matchPeople', 'multipleChoice', 'yesNoNotGiven', 'trueFalseNotGiven', 'matchingHeadings', 'sectionMatching', 'headingMatching'].includes(section.type)) {
                            section.items.forEach(item => {
                                totalQuestions++;
                                if (this.answers[item.number] === item.answer) {
                                    score++;
                                }
                            });
                        }
                        // Sentence completion with endings (select from options)
                        else if (section.type === 'sentenceCompletion' && section.endings) {
                            section.items.forEach(item => {
                                totalQuestions++;
                                if (this.answers[item.number] === item.answer) {
                                    score++;
                                }
                            });
                        }
                        // Fill in blank style questions (GT)
                        else if (section.type === 'sentenceCompletion' && !section.endings) {
                            section.items.forEach(item => {
                                totalQuestions++;
                                if (this.isCorrectFillItem(item.number, item.answer)) {
                                    score++;
                                }
                            });
                        }
                        // Note completion and summary completion (GT)
                        else if (section.type === 'noteCompletion' || section.type === 'summaryCompletion') {
                            section.items.forEach(item => {
                                totalQuestions++;
                                if (this.isCorrectFillItem(item.number, item.answer)) {
                                    score++;
                                }
                            });
                        }
                        // Notes and summary (Academic)
                        else if (section.type === 'notes' || section.type === 'summary') {
                            if (section.answers) {
                                Object.keys(section.answers).forEach(num => {
                                    totalQuestions++;
                                    if (this.isCorrectFill(section, parseInt(num))) {
                                        score++;
                                    }
                                });
                            }
                        }
                        // Table completion (GT)
                        else if (section.type === 'tableCompletion') {
                            section.rows.forEach(row => {
                                if (row.answers) {
                                    Object.keys(row.answers).forEach(num => {
                                        totalQuestions++;
                                        const userAnswer = (this.answers[num] || '').toLowerCase().trim();
                                        const correctAnswer = (row.answers[num] || '').toLowerCase().trim();
                                        if (userAnswer === correctAnswer) {
                                            score++;
                                        }
                                    });
                                }
                            });
                        }
                    });

                    // Save to per-passage state
                    this.passageSubmitted[passageIndex] = true;
                    this.passageScores[passageIndex] = { score, totalQuestions };

                    // Save all data to localStorage
                    if (this.currentTestId) {
                        localStorage.setItem(`reading_answers_test${this.currentTestId}`, JSON.stringify(this.answers));
                        localStorage.setItem(`reading_passage_passageSubmitted[currentPassageIndex]_test${this.currentTestId}`, JSON.stringify(this.passageSubmitted));
                        localStorage.setItem(`reading_passage_scores_test${this.currentTestId}`, JSON.stringify(this.passageScores));
                    }
                },

                resetQuiz() {
                    // Reset only current passage
                    const passageIndex = this.currentPassageIndex;
                    delete this.passageSubmitted[passageIndex];
                    delete this.passageScores[passageIndex];
                },

                clearReadingAnswers() {
                    this.answers = {};
                    this.passageSubmitted = {};
                    this.passageScores = {};
                    // Clear from localStorage
                    if (this.currentTestId) {
                        localStorage.removeItem(`reading_answers_test${this.currentTestId}`);
                        localStorage.removeItem(`reading_passage_passageSubmitted[currentPassageIndex]_test${this.currentTestId}`);
                        localStorage.removeItem(`reading_passage_scores_test${this.currentTestId}`);
                    }
                },

                // Listening functions
                getYoutubeEmbedUrl(url) {
                    if (!url) return '';
                    const videoId = url.match(/(?:youtube\.com\/watch\?v=|youtu\.be\/)([^&\s]+)/);
                    return videoId && videoId[1] ? `https://www.youtube.com/embed/${videoId[1]}` : '';
                },

                getGoogleDriveAudioUrl(url) {
                    if (!url) return '';
                    const match = url.match(/\/d\/([a-zA-Z0-9_-]+)/);
                    if (match && match[1]) {
                        // Use direct streaming URL
                        return `https://docs.google.com/uc?export=download&id=${match[1]}`;
                    }
                    return url;
                },

                getGoogleDrivePreviewUrl(url) {
                    if (!url) return '';
                    const match = url.match(/\/d\/([a-zA-Z0-9_-]+)/);
                    if (match && match[1]) {
                        return `https://drive.google.com/file/d/${match[1]}/preview`;
                    }
                    return url;
                },

                getGoogleDriveStreamUrl(url) {
                    if (!url) return '';
                    const match = url.match(/\/d\/([a-zA-Z0-9_-]+)/);
                    if (match && match[1]) {
                        // Use the direct streaming URL format
                        return `https://drive.google.com/uc?export=download&id=${match[1]}`;
                    }
                    return url;
                },

                // Timer functions
                formatTimer(seconds) {
                    const hrs = Math.floor(seconds / 3600);
                    const mins = Math.floor((seconds % 3600) / 60);
                    const secs = seconds % 60;
                    if (hrs > 0) {
                        return `${hrs}:${mins.toString().padStart(2, '0')}:${secs.toString().padStart(2, '0')}`;
                    }
                    return `${mins}:${secs.toString().padStart(2, '0')}`;
                },

                toggleReadingTimer() {
                    if (this.readingTimerRunning) {
                        clearInterval(this.readingTimerInterval);
                        this.readingTimerRunning = false;
                    } else {
                        this.readingTimerRunning = true;
                        this.readingTimerInterval = setInterval(() => {
                            this.readingTimer++;
                        }, 1000);
                    }
                },

                resetReadingTimer() {
                    clearInterval(this.readingTimerInterval);
                    this.readingTimer = 0;
                    this.readingTimerRunning = false;
                },

                toggleListeningTimer() {
                    if (this.listeningTimerRunning) {
                        clearInterval(this.listeningTimerInterval);
                        this.listeningTimerRunning = false;
                    } else {
                        this.listeningTimerRunning = true;
                        this.listeningTimerInterval = setInterval(() => {
                            this.listeningTimer++;
                        }, 1000);
                    }
                },

                resetListeningTimer() {
                    clearInterval(this.listeningTimerInterval);
                    this.listeningTimer = 0;
                    this.listeningTimerRunning = false;
                },

                selectListeningPart(index) {
                    this.currentListeningPartIndex = index;
                    this.currentListeningPart = null;
                    this.$nextTick(() => {
                        this.loadListeningPart();
                    });
                },

                loadListeningPart() {
                    if (this.listeningData && this.listeningData.parts) {
                        this.currentListeningPart = this.listeningData.parts[this.currentListeningPartIndex];
                        // Don't reset passageSubmitted[currentPassageIndex] state - it should persist from localStorage
                    }
                },

                setListeningAnswer(number, value) {
                    this.listeningAnswers[number] = value;
                    // Save to localStorage
                    if (this.currentTestId) {
                        localStorage.setItem(`listening_answers_test${this.currentTestId}`, JSON.stringify(this.listeningAnswers));
                    }
                },

                isCorrectListeningFill(number) {
                    if (!this.currentListeningPart?.answers) return false;
                    const userAnswer = (this.listeningAnswers[number] || '').toLowerCase().trim();
                    const correctAnswer = (this.currentListeningPart.answers[number] || '').toLowerCase().trim();
                    return userAnswer === correctAnswer;
                },

                isCorrectTableFill(number) {
                    if (!this.currentListeningPart?.tableSection?.tableAnswers) return false;
                    const userAnswer = (this.listeningAnswers[number] || '').toLowerCase().trim();
                    const correctAnswer = (this.currentListeningPart.tableSection.tableAnswers[number] || '').toLowerCase().trim();
                    return userAnswer === correctAnswer;
                },

                isCorrectNotesGroupFill(notesGroup, number) {
                    if (!notesGroup?.answers) return false;
                    const userAnswer = (this.listeningAnswers[number] || '').toLowerCase().trim();
                    const correctAnswer = (notesGroup.answers[number] || '').toLowerCase().trim();
                    return userAnswer === correctAnswer;
                },

                toggleChooseTwoAnswer(questionNumbers, letter) {
                    const selectedLetters = questionNumbers.map(num => this.listeningAnswers[num]).filter(Boolean);

                    if (selectedLetters.includes(letter)) {
                        questionNumbers.forEach(num => {
                            if (this.listeningAnswers[num] === letter) {
                                this.listeningAnswers[num] = null;
                            }
                        });
                    } else if (selectedLetters.length < 2) {
                        for (const num of questionNumbers) {
                            if (!this.listeningAnswers[num]) {
                                this.listeningAnswers[num] = letter;
                                break;
                            }
                        }
                    }
                    // Save to localStorage
                    if (this.currentTestId) {
                        localStorage.setItem(`listening_answers_test${this.currentTestId}`, JSON.stringify(this.listeningAnswers));
                    }
                },

                isChooseTwoSelected(questionNumbers, letter) {
                    return questionNumbers.some(num => this.listeningAnswers[num] === letter);
                },

                submitListeningAnswers() {
                    const partIndex = this.currentListeningPartIndex;
                    let score = 0;
                    let totalQuestions = 0;

                    const part = this.currentListeningPart;
                    if (!part) return;

                    if (part.type === 'multipleChoice' || part.type === 'complex') {
                        part.items.forEach(item => {
                            if (item.type === 'chooseTwoGroup') {
                                totalQuestions += 2;
                                const userAnswers = item.questionNumbers.map(n => this.listeningAnswers[n]).filter(Boolean);
                                item.answers.forEach(ans => {
                                    if (userAnswers.includes(ans)) score++;
                                });
                            } else if (item.type === 'matchingGroup') {
                                item.items.forEach(matchItem => {
                                    totalQuestions++;
                                    if (this.listeningAnswers[matchItem.number] === item.answers[matchItem.number]) {
                                        score++;
                                    }
                                });
                            } else if (item.type === 'flowchart') {
                                item.items.forEach(flowItem => {
                                    totalQuestions++;
                                    if (this.listeningAnswers[flowItem.number] === item.answers[flowItem.number]) {
                                        score++;
                                    }
                                });
                            } else if (item.type === 'multipleChoice') {
                                item.items.forEach(mcItem => {
                                    totalQuestions++;
                                    if (this.listeningAnswers[mcItem.number] === mcItem.answer) {
                                        score++;
                                    }
                                });
                            } else if (item.type === 'notesGroup') {
                                if (item.answers) {
                                    Object.keys(item.answers).forEach(num => {
                                        totalQuestions++;
                                        if (this.isCorrectNotesGroupFill(item, parseInt(num))) {
                                            score++;
                                        }
                                    });
                                }
                            } else if (item.number) {
                                totalQuestions++;
                                if (this.listeningAnswers[item.number] === item.answer) {
                                    score++;
                                }
                            }
                        });
                    } else if (part.type === 'notes') {
                        if (part.answers) {
                            Object.keys(part.answers).forEach(num => {
                                totalQuestions++;
                                if (this.isCorrectListeningFill(parseInt(num))) {
                                    score++;
                                }
                            });
                        }
                        if (part.tableSection?.tableAnswers) {
                            Object.keys(part.tableSection.tableAnswers).forEach(num => {
                                totalQuestions++;
                                if (this.isCorrectTableFill(parseInt(num))) {
                                    score++;
                                }
                            });
                        }
                    }

                    // Save to per-part state
                    this.listeningPartSubmitted[partIndex] = true;
                    this.listeningPartScores[partIndex] = { score, totalQuestions };

                    // Save all data to localStorage
                    if (this.currentTestId) {
                        localStorage.setItem(`listening_answers_test${this.currentTestId}`, JSON.stringify(this.listeningAnswers));
                        localStorage.setItem(`listening_part_submitted_test${this.currentTestId}`, JSON.stringify(this.listeningPartSubmitted));
                        localStorage.setItem(`listening_part_scores_test${this.currentTestId}`, JSON.stringify(this.listeningPartScores));
                    }
                },

                // Check if current part is submitted
                isCurrentPartSubmitted() {
                    return this.listeningPartSubmitted[this.currentListeningPartIndex] === true;
                },

                // Get current part score
                getCurrentPartScore() {
                    return this.listeningPartScores[this.currentListeningPartIndex] || { score: 0, totalQuestions: 0 };
                },

                resetListeningQuiz() {
                    // Reset only current part
                    const partIndex = this.currentListeningPartIndex;
                    delete this.listeningPartSubmitted[partIndex];
                    delete this.listeningPartScores[partIndex];
                },

                clearListeningAnswers() {
                    this.listeningAnswers = {};
                    this.listeningPartSubmitted = {};
                    this.listeningPartScores = {};
                    // Clear from localStorage
                    if (this.currentTestId) {
                        localStorage.removeItem(`listening_answers_test${this.currentTestId}`);
                        localStorage.removeItem(`listening_part_submitted_test${this.currentTestId}`);
                        localStorage.removeItem(`listening_part_scores_test${this.currentTestId}`);
                    }
                }
            };
        }

        // Global function for Google Drive streaming URL
        function getGoogleDriveStreamUrl(url) {
            if (!url) return '';
            const match = url.match(/\/d\/([a-zA-Z0-9_-]+)/);
            if (match && match[1]) {
                return `https://drive.google.com/uc?export=download&id=${match[1]}`;
            }
            return url;
        }

        // Audio Player Component
        function audioPlayer() {
            return {
                isPlaying: false,
                currentTime: 0,
                duration: 0,
                progress: 0,
                volume: 1,
                isMuted: false,
                playbackRate: '1',

                togglePlay() {
                    const audio = this.$refs.audioElement;
                    if (!audio) return;

                    if (audio.paused) {
                        audio.play().catch(e => console.log('Play error:', e));
                    } else {
                        audio.pause();
                    }
                },

                updateProgress() {
                    const audio = this.$refs.audioElement;
                    if (!audio) return;

                    this.currentTime = audio.currentTime;
                    this.progress = (audio.currentTime / audio.duration) * 100 || 0;
                },

                seek(event) {
                    const audio = this.$refs.audioElement;
                    if (!audio || !audio.duration) return;

                    const rect = event.currentTarget.getBoundingClientRect();
                    const percent = (event.clientX - rect.left) / rect.width;
                    audio.currentTime = percent * audio.duration;
                },

                skipTime(seconds) {
                    const audio = this.$refs.audioElement;
                    if (!audio) return;

                    audio.currentTime = Math.max(0, Math.min(audio.duration, audio.currentTime + seconds));
                },

                setVolume() {
                    const audio = this.$refs.audioElement;
                    if (!audio) return;

                    audio.volume = this.volume;
                    this.isMuted = this.volume === 0;
                },

                toggleMute() {
                    const audio = this.$refs.audioElement;
                    if (!audio) return;

                    if (this.isMuted) {
                        audio.volume = this.volume || 1;
                        this.isMuted = false;
                    } else {
                        audio.volume = 0;
                        this.isMuted = true;
                    }
                },

                setPlaybackRate() {
                    const audio = this.$refs.audioElement;
                    if (!audio) return;

                    audio.playbackRate = parseFloat(this.playbackRate);
                },

                formatAudioTime(seconds) {
                    if (!seconds || isNaN(seconds)) return '0:00';
                    const mins = Math.floor(seconds / 60);
                    const secs = Math.floor(seconds % 60);
                    return `${mins}:${secs.toString().padStart(2, '0')}`;
                }
            };
        }
    </script>

</body>

</html>